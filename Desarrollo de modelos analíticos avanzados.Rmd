---
title: "Análisis de los Datos"
subtitle: "Evidencia 1: Planeación estratégica basada en analítica prescriptiva"
author: "Carolina Velarde, Ximena Martínez, Chantal Simó, Kízari Hernández"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_depth: 5
    theme: "spacelab"
    code_folding: hide
    toc_float:
      smooth_scroll: true
      collapsed: true
editor_options: 
  chunk_output_type: inline 
---
El análisis exploratorio de los datos disponibles, predicciones, selección de posibles clientes y uso de fuentes secundarias se hace a conitnuación. Los hallazgos se describen con detalle en el documento de la evidencia 1.

```{r include=FALSE}
spectral <- c("#9E0142", "#D53E4F","#F46D43", "#FDAE61" ,"#FEE08B"  ,"#DFF27D" , "#90D289" ,"#66C2A5" ,"#3288BD","#5E4FA2")
                       
spectral2 <- c("#C92C3E","#E4969F","#F98E52" ,"#FED872" ,"#DFF27D" ,"#90D289","#65B540","#55C1A0","#3288BD","#7494EA","#5E4FA2")
colores <- c("#5EA7D4","#7769B5") 
colores2 <- c("#90D289" ,"#65B540","#55C1A0","#58B09C","#3288BD","#A6BAF2","#7494EA","#7769B5","#5E4FA2")

```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=F,warning=F)
pacman::p_load(tidyverse,ggplot2,dplyr,magrittr,data.table,sqldf)
pacman::p_load(sf,RColorBrewer,leaflet.extras2,readxl,forecast,tseries)
```

# **Análisis Exploratorio de bases de datos disponibles**
\
Tenemos 5 bases de datos a analizar. 
\
- **Clientes**: con información de los 100 clientes de la empresa.
\
- **Catálogo**: con información de los 102 productos que vende la empresa.
\
- **Detalle**: con información de los 154,059 productos pedidos a lo largo de los 30,000 tickets por los clientes entre enero del 2020 y febrero del 2023.
\
- **Pedido**: con información de los 30,000 pedidos entre enero del 2020 y febrero del 2023.
\

## <u>Catalogo</u>

\
```{r}
catalogo <- fread(input="/Users/carolina/Desktop/reto/Data/Ventas/catalogo.csv")
```

En Catálogo hay:
\
- **mls**: Describe al producto (mililitros)
\
- **gms**: Describe al producto (gramos)
\
- **precio_unidad**: Precio de 1 unidad 
\
- **familia**: familia del producto
\
- **categoria**: categoría del producto
\
- **sku**: sku del producto
\
- **id_producto**: Id del producto
\
- **nombre**: Nombre del producto
\
- **activo**: si está activo o no
\

### *Precio Unidad*

\
A continuación podemos ver la distribución del precio unitario de los productos. El 75% de los productos tienen un precio de 124. El producto de menor precio es de 12 y el mayor es de 250.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 1.** Distribución de Precios en Catálogo'}
ggplot(catalogo,aes(precio_unidad)) + geom_histogram(color="#5E9FD4",fill="#7EB2DD") + theme_light() + labs(title="Distribución del Precio Unitario")  +xlab("")+ylab("") +theme(plot.title = element_text(hjust = 0.5))
```

### *Familia y Categoría*
\
Como podemos observar, solo hay 2 categorías de producto en la familia categoría. Para un mejor análisis, estas variables se juntarán.
\
```{r}
table(catalogo$familia,catalogo$categoria)
```

```{r fig.align='center'}
catalogo %<>%  unite(Categoria_Familia,categoria, familia, sep = "_") 
catalogo %>% count(Categoria_Familia,sort=T) %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
```

Ahora podemos ver la distribución de precio por categoría. La categoría con precios más altos es la de normal_preparado, seguido de congelado_preparado 
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 2.** Distribución de Precios en Catálogo'}
ggplot(catalogo,aes(x= Categoria_Familia, y= precio_unidad,color=Categoria_Familia)) +
  theme_light()  + scale_color_manual(values = colores2)  +
  labs(title="Distribución de Precio Unitario",subtitle = "Por Categoría")+ylab("Ventas ")+xlab("Unidades")  +
  theme(legend.position="", axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) +  
  geom_jitter(width = .3, alpha = .7,size=2.5) +theme(plot.title = element_text(hjust = 0.5))
```

### *Eliminando Variables* 
\

#### mls y gms

\
8 productos que tienen mls y gms en na. 6 son preparados. Asumimos que son piezas. 
\
```{r}
catalogo %>% filter(mls =="n/a"&gms=="n/a") %>% rmarkdown::paged_table()
```
81 productos que tienen mls en na y no gms en na. La mayoría es producto animal.
\
```{r}
catalogo %>% filter(mls =="n/a"&!gms=="n/a")  %>% rmarkdown::paged_table()
```

#### sku, id_producto

\
id_producto será la llave que usaremos para conectar con otras bases, se eliminará sku y nombre. El único que se repite es pierna. El producto 17 es Carnitas/Pierna y el producto 77 es Pierna.
\
```{r}
catalogo  %<>% dplyr::select(-sku)
```

#### Productos Activos

\
Todos son TRUE, por lo que se omitira
\
```{r}
catalogo %>% count(activo)  %>% rmarkdown::paged_table()
catalogo %<>% dplyr::select(-mls,-gms,-activo)
```


### *Visualizacion de la base limpia *
\
Nos quedamos con id_producto y nombre como variables id y precio_unidad y Categoria_Familia como variables descriptivas del producto.
\
```{r}
glimpse(catalogo)
```

## <u>Detalle</u>
\
```{r}
detalle <- read_csv("/Users/carolina/Desktop/reto/Data/Ventas/detalle.csv") %>% dplyr::select(-id_detalle)
```

En detalle tenemos cada ticket a nivel producto por ticket. La base incluye:
\
- **id_detalle**: el id de cada producto de cada transacción. Se eliminará esta variable.
\
- **id_pedido**: el id de cada pedido
\
- **id_producto**: el id de cada producto dentro de esa transacción
\
- **cantidad**: la cantidad de unidades de ese producto
\
La mayoría de los productos se tienden a ordenar de entre 15 a 30 piezas.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 3.** Cantidad de Productos por Ticket'}
ggplot(detalle,aes(cantidad)) + geom_histogram(color="#5E9FD4",fill="#7EB2DD") +theme_light() +
  labs(subtitle="Cantidad de Productos por Ticket")  +xlab("")+ylab("") + scale_y_continuous(labels = scales::comma) +
  theme(plot.title = element_text(hjust = 0.5))

```

## <u>Pedido</u>
```{r}
pedido <- read_csv("/Users/carolina/Desktop/reto/Data/Ventas/pedido.csv")
```


En Pedido hay:
\
- **id_pedido**: el id de cada pedido
\
- **id_cliente** el id del cliente que hizo la compra
\
- **fechapedido**: la fecha en la que se hizo el pedido
\
- **fechaeentrega**: la fecha en la que se hizo la entrega
\
- **cancelado**: si la venta fue cancelada o no.
\

### *Fechas de pedidos y de entrega*

\
Se transformarán las fechas a el tipo de dato correcto y se hará una columna que mida cuántos días se tardó cada orden. Se usará mes y año como factor. Se eliminará fechaentrega
\
```{r fechas}
pedido %<>% mutate( fechapedido = as.Date(pedido$fechapedido, format = "%d/%m/%y"),
                    fechaentrega= as.Date(pedido$fechaentrega, format = "%d/%m/%y"),
                    tiempo = as.factor(fechaentrega-fechapedido))
pedido %<>% mutate( año_pedido = as.factor(format(pedido$fechapedido, "%Y"))) 
```


Hay 42 pedidos  sin fecha de entrega. Estos no tienen la fecha por el corte en la recolección de datos, por lo que NA days se reemplazará como En curso.
\
```{r}
pedido %>% filter(is.na(tiempo)) %>% dplyr::select(fechapedido,fechaentrega,id_pedido) %>% rmarkdown::paged_table()
```

Como podemos observar, el tiempo de entrega es entre 1 y 3 días, con el 82% de los pedidos son entregados en entre 1 y 2 días.
\
```{r}
pedido %<>% mutate(tiempo=as.factor(ifelse(is.na(tiempo),"En curso",tiempo)))%>% dplyr::select(-fechaentrega)
pedido %>% count(tiempo)  %>% mutate(Frecuencia = scales::percent( n /sum(n),accuracy = 0.1))  %>% rmarkdown::paged_table()
```



### *Pedidos Cancelados*
\
Solo el 5% de los pedidos han sido cancelados.
\
```{r}
pedido %>% count(cancelado) %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
pedido %<>% mutate(cancelado=as.factor(cancelado))
```

### *Visualizacion de la base limpia*
\
```{r}
glimpse(pedido)
```



## <u>Clientes</u>
\
- **id_cliente**: llave conectora
\
-**lat y long**: latitdud y longitud
\
-**nom_estab y raz_social**: Nombre del negocio y su razón social
\
-**per_ocu**: La ocupación de cada cliente
\
-**tipo_vial, nom_vial**: Información de la ubicación (tipo de calle y nombre de la calle)
\
-**edificio, edificio_e**: Información de la ubicación
\
-**tipo_asent, nomb_Asent**: Información de la ubicación
\
-**tipoCenCom, nom_CenCom, num_local**: Información de la ubicación si está en un centro comercial
\
-**cod_postal,cve_ent,entidad**: Información de la ubicación, estado en el que está
\
-**cve_mun,municipio**: Muncipio en el que está
\
- **cve_loc, ageb, manzana**: Información de la ubicación
\
```{r}
clientes <- read_csv("/Users/carolina/Desktop/reto/Data/Ventas/clientes.csv")
```

### *Limpieza de las variables de nom_estab y raz_social*
\
De los 100 clientes, 63 no tienen razón social, esta se eliminará. nom_estab no tiene na's
\
```{r}
sum(is.na(clientes$raz_social))
sum(is.na(clientes$nom_estab)) 
clientes  %<>% dplyr::select(-raz_social)
```

### *Análisis de tipoCenCom, nom_CenCom, num_local*
\
Hay solo 16 clientes en centros comerciales, mercaods o edificios comerciales, por eso los na's. Hay 3 clientes que no están en un centro que tienen número de local. Como estas variables describen a solo el 16% de los clientes, se creará una nueva variable que describe si es un centro comercial o no, y se eliminarán estas variables.
\
```{r}
clientes %>% count(tipoCenCom,sort=T) %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
clientes %<>% mutate(CenCom = as.factor(ifelse(is.na(tipoCenCom),0,1))) %>% dplyr::select(-tipoCenCom,-nom_CenCom,-num_local)
```

### *Análisis de cve_mun y municipio*
\
El 50% de los clientes son de Monterrey.
\
```{r}
clientes %>% count(municipio,cve_mun,sort=T)  %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
```

Para el análisis geográfico es necesario usar cve_mun con 3 dígitos. Los que no tienen 3 en total tendrán uno o 2 0's al principio.
\
```{r}
clientes %<>% mutate(cve_mun =
                   ifelse(nchar(cve_mun)==2,paste0("0",cve_mun),
                          ifelse(nchar(cve_mun)==1,paste0("00",cve_mun),cve_mun)))
```

### *Transformacion de la variable per_ocu*
\
El 73% de los clientes tienen una ocupación de entre 1 a 10 personas.
\
```{r}
clientes %>% count(per_ocu,sort=T) %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
clientes %<>% mutate(per_ocu =as.factor(per_ocu))
```

### *Eliminación de variables*
\

#### tipo_vial, nom_vial

\
Tipo vial describe el tipo de vialidad en la que está ubicado el negocio, y nom_vial es el nombre. No se usarán estas variables.
\
```{r}
clientes %>% count(tipo_vial,sort=T)  %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
clientes %<>% dplyr::select(-nom_vial,-tipo_vial)
```

#### edificio, edificio_e
\
Mas del 80% de los clientes tienen estas columnas en na, por lo que no se usarán. (Estas columnas son para los clientes que se encuentran dentro de edificios como centros comerciales.)
\
```{r}
sum(is.na(clientes$edificio))
sum(is.na(clientes$edificio_e))
clientes  %<>% dplyr::select(-edificio,-edificio_e)
```

#### Tipo_asent, nomb_Asen
\
El asentimiento con más clientes es el centro, con 12. El nombre del asentimiento tiene errores de estandarización. No es útil para el análisis.
\
```{r}
clientes %>% count(nomb_asent,sort=T)  %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table() 
```
El 89% de los clientes están ubicados en colonias.
\
```{r}
clientes %>% count(tipo_asent,sort=T)  %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
clientes   %<>%  dplyr::select(-tipo_asent,-nomb_asent) #No se usarán estas columnas.
```

#### Cod_postal,cve_ent,entidad
\
22 clientes están en el mismo código postal. Hay un cliente con na. Ya que el análisis geográfico se haría a nivel ageb, también se excluirá código postal. Todos los clientes son de Nuevo Léon, por lo que cve_ent y entidad son lo mismo para cada uno. 
\
```{r}
clientes %>% count(cod_postal,cve_ent,sort=T) %>% mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
clientes %<>% dplyr::select(-cve_ent,-entidad,-cod_postal)
```

#### cve_loc, ageb, manzana
\
Un AGEB o Área Geoestadística Básica es la extensión territorial que corresponde a la subdivisión de un municipio y estos pueden ser urbanos o rurales. Son la extensión territorial ocupada por un conjunto de manzanas o cuadras, estas pueden ser un grupo de 1 a 50. Los limites de un AGEB urbano son perfectamente delimitadas por calles, avenidas, andadores o cualquier otro rasgo de fácil identificación en el terreno.
\
Hay 3 localidades. Esta columna se excluirá del análisis. También se excluirá manzana ya que lo más profundo que se llegaría a hacer el análisis es a nivel ageb.
\
```{r}
clientes %>% count(cve_loc)  %>% rmarkdown::paged_table()
clientes  %<>% dplyr::select(-cve_loc,-manzana)
```




### *Creción de nuevas variables *
\

#### Tipo de Actividad

\
Se creará una nueva variable para clasificar a los clientes según su actividad (Restaurante o Hotel) a partir del nombre del establecimiento. El 76% de los clientes son Restaurantes.
\
```{r}
clientes$actividad <- grepl("RESTAURANTE", clientes$nom_estab, ignore.case = TRUE)
clientes$actividad <- as.factor(clientes$actividad)
clientes %<>% mutate(actividad = forcats::fct_collapse(clientes$actividad,
                                             "Restaurante" =  c("TRUE"),
                                             "Hotel" = c("FALSE"))) 
clientes %>% count(actividad,sort=T)%>%   mutate(Frecuencia = scales::percent( n /sum(n))) %>% rmarkdown::paged_table()
```

#### Estatus
\
A partir de los pedidos hechos en pedido se creará una variable que determine si el cliente es activo o no. Si el cliente ha hecho mínimo una compra se catalogará como activo.
\
Dentro de los 100 clientes, 56 son activos. El cliente que más ha hecho pedidos es el 24 	RESTAURANTE ARIECCHINO, con 862 pedidos y el que menos ha hecho es el cliente 2  RESTAURANTE FINOS, con 236 pedidos.
\
```{r}
detallec <- pedido %>% count(id_cliente,sort=T) %>% dplyr::select(id_cliente)
detallec <- as.list(detallec$id_cliente)
clientes %<>% mutate(Estatus = as.factor(ifelse(id_cliente%in%detallec,"Activo","Pasivo")))
rm(detallec)
clientes %>% count(Estatus,sort=T)%>%   mutate(Frecuencia = scales::percent( n /sum(n)))  %>% rmarkdown::paged_table()
```

Repitiendo el conteo de clientes por municipio tomando en cuenta el estatus del cliente, podemos ver que no hay clientes activos en Cadereyta ni en Juárez.
\
```{r}
table(clientes$municipio,clientes$Estatus)
```


### *Visualizacion de la base limpia*
\
```{r}
glimpse(clientes)
```


## <u>Unión de Bases</u>

\

### *Modelo Entidad Relación* 

\
Con este modelo podemos ver como es la relación de las bases de datos dadas por el socio formador. 
\
- Aquí podemos ver que la base de Catálogo se une con la de Detalles por el ID de productos. Esta unión la llamamos Base1 
\
- Por otro, tenemos  que la base de Clientes se une con la de Pedidos por el ID de clientes Esta unión la llamamos Base2
\
- Ambas bases se unen con el ID perdido creando la unión de las 4 bases de datos.
\
- La base de prospectos no tiene unión con ninguna de la bases internas de la empresa
\
- Primero se unen detalle y catalogo. 
\
![](/Users/carolina/Library/CloudStorage/GoogleDrive-a01720509@tec.mx/Shared drives/Planeación estratégica/Reto/er.jpeg)

```{r}
base1 <- merge(detalle,catalogo, by.x = "id_producto", by.y = "id_producto", all.x = T)
base2 <- merge(pedido,clientes, by.x = "id_cliente", by.y = "id_cliente", all.X = T)
base <- merge(base1,base2, by.x = "id_pedido", by.y = "id_pedido", all.x = T)
rm(base1,base2,catalogo,detalle,pedido)
```


## <u>Creación de nuevas variables</u>
\

#### *Ventas por detalle (producto en ticket)*

\
Se crea la variable de venta, la cual representa las ventas $ por producto en el ticket.
\
```{r}
base$ventas <- base$cantidad * base$precio_unidad
```

#### *Ventas por ticket*
\
Se crean las variables de total monetario y total unitario de cada ticket.
\
```{r}
base %<>% group_by(id_pedido) %>%  mutate(cantidad_pedido = sum(cantidad),
            ventas_pedido = sum(ventas)) %>% ungroup()
```

#### *Ventas por cliente*
\
Ahora se crean variables del total por cada cliente.Se crean las variables de total monetario y total unitario de cada ticket.
\
```{r}
base %<>% group_by(id_cliente) %>% mutate(cantidad_cliente = sum(cantidad_pedido),
            ventas_cliente = sum(ventas_pedido)) %>% ungroup()
```

Se unirán estos datos a la base de cliente
\
```{r}
totales <- base %>% dplyr::select(id_cliente,cantidad_cliente,ventas_cliente)
totales <- distinct(totales)
clientes<- merge(clientes,totales, by.x = "id_cliente",by.y = "id_cliente",all=T)
rm(totales)
```


# **Análisis Exploratorio de datos disponibles unidos**
\
```{r}
skimr::skim(base)
```
## <u>Ventas</u>
\

### *Totales Por cliente*

\
¿Cómo se han comportado los clientes históricamente?

\
Podemos ver una clara división entre los clientes.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráficos 4 y 5.** Totales por Cliente (Distribución y Unidades)'}
ventas <- ggplot(clientes,aes(ventas_cliente)) + geom_histogram(color="#5E9FD4",fill="#7EB2DD") +theme_light() + labs(title="Ventas  totales de Clientes")  +xlab("")+ylab("") + scale_x_continuous(labels = scales::comma) +
  theme(plot.title = element_text(hjust = 0.5))
options(scipen = 999)
ventas2 <- ggplot(clientes,aes(y= ventas_cliente,x=cantidad_cliente)) +
  geom_point(size=5, shape= 21,color="#5E9FD4",fill="#7EB2DD")   +
  labs(title="Ventas totales de Clientes",subtitle = "")+ylab("ventas")+xlab("cantidad")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5)) + 
  scale_y_continuous(labels = scales::comma) +theme_light() 
cowplot::plot_grid(ventas,ventas2,ncol=1)
```

### *Totales por Tipo de comercio*

\
Esta división se ve en tipo de comercio. Existen más restaurantes con menos ventas, mientras que hay más hoteles con más ventas
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 6.** Totales por Cliente Según el Comercio'}
ggplot(clientes,aes(x= actividad, y= ventas_cliente,color=actividad)) +
  theme_light()   + scale_color_manual(values = colores) +
  labs(title="Ventas totales de Clientes",subtitle = "Por tipo de Comercio")+ylab("")+xlab("")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5)) +  
  geom_jitter(width = .3, alpha = .8,size=4)  + scale_y_continuous(labels = scales::comma)
```

### *Totales Por Municipio*
\
Como podemos ver, tanto en Apodaca como Salinas Victoria solo hay perfiles que gastan menos, mientras que en Santiago hay un perfil que gasta más.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 7.** Totales por Cliente Según su Municipio'}
clientes %>% filter(Estatus=="Activo") %>% droplevels() %>% 
  ggplot(aes(x= municipio, y= ventas_cliente,color=municipio)) +
  theme_light() + scale_color_manual(values = colores2) +
  labs(title="Ventas totales de Clientes",subtitle = "Por Municipio")+ylab("")+xlab("")  +
  theme(legend.position="",axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  geom_jitter(width = .2, alpha = 1,size=2.5)  + scale_y_continuous(labels = scales::comma)
```



### *Totales por ocupación*

\
Los clientes con ocupación de 31 a 50 personas gastan menos.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 8.** Totales por Cliente Según su Municipio'}
clientes %>% filter(Estatus=="Activo") %>% droplevels() %>% 
  ggplot(aes(x= per_ocu, y= ventas_cliente,color=per_ocu)) +
  theme_light()  + scale_color_manual(values = colores2)  +
  labs(title="Ventas totales de Clientes Activos",subtitle = "por Ocupación")+ylab("")+xlab("")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5)) +  
  geom_jitter(width = .3, alpha = .8,size=3) + scale_y_continuous(labels = scales::comma)
```

### *Totales por Centro com*

\
Ambos perfiles están dividios de manera similar.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 9.** Totales por Cliente Según si es Centro Comercial'}
ggplot(clientes,aes(x= CenCom, y= ventas_cliente,color=CenCom)) +
  theme_light()   +
  labs(title="Ventas totales de Clientes Activos",subtitle = "Centro Comercial")+ylab("")+xlab("")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5)) +
  geom_jitter(width = .3, alpha = 0.9,size=3) + scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = colores)
```


### *Encontrando patrones (correlación)*
\
Como podemos ver, existen 2 grupos pero no hay patron, los clasificaremos y veremos como afecta. La mitad de los clientes activos gastan menos
\
```{r}
clientes  %<>% mutate(Tipo = as.factor(ifelse(ventas_cliente>20000000,"1","0")))
clientes %>% count(Tipo,sort=T) %>% mutate(Frecuencia = scales::percent( n /sum(n))) %>% na.omit()  %>% rmarkdown::paged_table()
```
\
Como podemos observar, fuera de las ventas lo que más afectan son los municipios en los que sabemos que no hay perfiles de bajo gasto.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Correlación 1.** Perfil de Gasto'}
cor <- clientes %>% filter(Estatus=="Activo") %>% dplyr::select(-cve_mun,-lat,-long,-id_cliente,-nom_estab,-localidad,-ageb,-Estatus) %>% mutate(municipio=as.factor(municipio)) %>% droplevels()
cor <- model.matrix(~0+., data=cor) 
cor <- round(cor(cor),4)
corrplot::corrplot(cor,method = 'color', order = 'original', tl.srt=90,tl.col="black",cl.pos = 'b', 
                   addgrid.col = 'white',tl.cex =0.75)
```


```{r}
base  %<>% mutate(Tipo = as.factor(ifelse(ventas_cliente>20000000,"Alto","Bajo"))) 
```


## <u>Tickets</u>
\

### *Total del ticket y Total del ticket por tipo de cliente*

\
Como es esperado, los totales del ticket de los clientes que gastan menos son menores.
\
```{r fig.align='center',warning=FALSE,out.width='85%',fig.cap='**Gráfico 10 y 11.** Totales por Ticket Según el Tipo de Cliente'}
aa <- base %>% dplyr::select(id_cliente,ventas_pedido,Tipo) %>% distinct() %>% 
ggplot(aes(ventas_pedido)) + geom_histogram(color="#5E9FD4",fill="#7EB2DD") +theme_light() + 
  labs(title="Totales de Ticket")  +xlab("")+ylab("") + scale_x_continuous(labels = scales::comma) +
  facet_wrap(~Tipo,ncol=2) +theme(plot.title = element_text(hjust = 0.5))
options(scipen = 999)
bb <- base %>% 
  dplyr::select(Tipo,id_pedido,cantidad_pedido,ventas_pedido) %>% distinct() %>%  ggplot(aes(y= ventas_pedido,x=cantidad_pedido,fill=Tipo)) +
  theme_light() +geom_point(size=2, shape= 21)  + scale_color_manual() +
  labs(title="Ticket",subtitle = "")+ylab("ventas")+xlab("cantidad")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5))  +
  scale_y_continuous(labels = scales::comma) + scale_x_continuous(labels = scales::comma) +
  geom_smooth(color="black", alpha=4, size=1, fill="#D9F7FA") + scale_fill_manual(values = colores) + facet_wrap(~Tipo) 
cowplot::plot_grid(bb,aa,ncol = 1)
```

### *Total del ticket por tipo de comercio*

\
Esto también se refleja en el tipo de comercio. 
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 12.** Totales Según Tipo y Comercio'}
 base %>% dplyr::select(Tipo,actividad,id_pedido,cantidad_pedido,ventas_pedido) %>% distinct() %>% droplevels() %>% 
  ggplot(aes(x= ventas_pedido,y=actividad,color=actividad)) +
  theme_light()  + scale_color_manual(values = colores2)  +
  labs(title="Tickets Por Tipo de Comercio")+ylab("")+xlab("")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5)) +  
  geom_jitter(width = .15, alpha = 0.8,size=1) + scale_x_continuous(labels = scales::comma)  + facet_wrap(~Tipo,ncol=1)
```

### *Total del ticket por municipio*
\
Al igual que en los municipios.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 13.** Totales Según Tipo y Municipio'}
base %>% dplyr::select(Tipo,municipio,id_pedido,cantidad_pedido,ventas_pedido) %>% 
  distinct() %>% droplevels() %>% ggplot(aes(x= ventas_pedido,y=municipio,color=municipio)) + 
  geom_jitter(width = .05, alpha = 0.8,size=0.8)+
  theme_light()  + scale_color_manual(values = colores2)  +
  labs(title="Tickets por Municipio")+ylab("")+xlab("")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5)) +  
  scale_x_continuous(labels = scales::comma)  + facet_wrap(~Tipo,ncol=1)
```

### *Total del ticket por ocupación*

\
También en ocupación. 
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 14.** Totales Según Tipo y Ocupación'}
base %>% dplyr::select(Tipo,per_ocu,id_pedido,cantidad_pedido,ventas_pedido) %>% distinct() %>% droplevels() %>% 
  ggplot(aes(x= ventas_pedido,y=per_ocu,color=per_ocu)) +
  theme_light()  + scale_color_manual(values = colores2)  +
  labs(title="Tickets por Ocupación")+ylab("")+xlab("")  +
  theme(legend.position="",plot.title = element_text(hjust = 0.5)) +  
  geom_jitter(width = .1, alpha = .8,size=1) + scale_x_continuous(labels = scales::comma)  + facet_wrap(~Tipo,ncol=1)
```

# **Modelos De Market Basket, Regresión y Series de Tiempo**
\

## <u>Market Basket para la recurrencia</u>

\
Para detectar órdenes recurrentes, hicimos un análisis tipo market basket para las 30 mil órdenes con los 102 productos.
\
```{r}
market_basket <- pivot_wider(base,
  id_cols = c(id_pedido,id_cliente),
  names_from = nombre,values_from = id_producto, values_fn = length, values_fill = 0)
cantidades_mb <- market_basket
group_cols <- c(3:104)
market_basket[group_cols] <- lapply(market_basket[group_cols], as.factor)
market_basket %<>% mutate_if(is.factor, function(x) as.factor(ifelse(x != "0", "1", "0")))
```


Solo hay 26 clientes que han hecho un total de 36 órdenes repetidas. El cliente que más las ha hecho es RESTAURANTE BONDIA, con 5 órdenes recurrentes. En total, las órdenes recurrentes representan el 0.0012% del total de todas las órdenes.
\
```{r}
group_cols <- c(2:104)
market_basket %>%
  group_by(across(group_cols)) %>%
  count() %>% filter(n > 1) %>% ungroup() %>%
  count(id_cliente,sort=T) %>%   mutate(Frecuencia = scales::percent( n /30000)) %>% rmarkdown::paged_table() 
```

## <u>Market Basket frecuencia de productos</u>
\
Ahora, analizando las órdenes, ¿cuáles son los productos más ordenados? ¿Cuántas unidades se piden por orden? ¿ Cuánto generan en ingresos?
\

```{r}
recurrencia_prod <- cantidades_mb %>% dplyr::select(-id_pedido,-id_cliente)
recurrencia_prod %<>% mutate_if(is.numeric, function(x) as.numeric(ifelse(x == 0, 0, 1)))
recurrencia_prod <- colSums(recurrencia_prod)
recurrencia_prod <- data.frame(Producto = names(recurrencia_prod), Presencia_en_Ticket = recurrencia_prod)
```

```{r}
cantidades <- cantidades_mb %>% dplyr::select(-id_pedido,-id_cliente)
cantidades <- colSums(cantidades)
product_counts_df <- data.frame(Producto = names(cantidades), Cantidad_Total = cantidades)
```

Los 10 principales productos en términos de recurrencia, cantidad de pedidos y ventas son: Salmón, pastel, lomo, jalapeño, deshebrada, panela, philadelphia, diezmillo, bacon y mostaza. Con esta información, se pudo desarrollar estrategias para impulsar estos productos y seleccionar prospectos con los cuales promocionarlos en el catálogo.
\
```{r}
mb<- merge(recurrencia_prod,product_counts_df, by.x = "Producto",by.y = "Producto",all=T)
precios <- base %>% dplyr::select(nombre,precio_unidad) %>% distinct()
mb<- merge(mb,precios, by.x = "Producto",by.y = "nombre",all=T)
mb%>% mutate(Ganancia = precio_unidad*Cantidad_Total) %>% arrange(desc(Ganancia))  %>% rmarkdown::paged_table()
```

## <u>Regresiones</u>
\
Para hacer la regresión, es necesario transformar los datos de manera que la predicción sea del total del ticket. Se hará una transformación similar a la market basket, pero con cartegoría y familia en vez de productos.
\
```{r}
datos_regresion <- pivot_wider(base,
  id_cols = c(ventas_pedido,id_pedido,id_cliente,tiempo,fechapedido,cancelado,per_ocu,municipio,CenCom,actividad,cantidad_pedido,Tipo,cve_mun),
  names_from = Categoria_Familia,values_from = Categoria_Familia, values_fn = length, values_fill = 0)
datos_regresion$municipio <- as.factor(datos_regresion$municipio)
```

### *Transformación de datos*

Como podemos ver, no es necesario transformar la variable dependiente.
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 15.** Distribución de Ventas por Pedido'}
options(scipen = 999)
ggplot(datos_regresion,aes(ventas_pedido)) + geom_histogram(color="#5E9FD4",fill="#7EB2DD") +theme_light() + labs(title="Distribución de las Ventas")  +xlab("")+ylab("") + scale_x_continuous(labels = scales::comma) +theme(plot.title = element_text(hjust = 0.5))
```

Convertiremos las 2 variables de factor con múltiples niveles (per_ocu y municipio) a columnas binarias para una mejor precisión en el modelo.
\
```{r}
datos_regresion %<>% mutate(per_ocu_0a5 = as.factor(ifelse(per_ocu=="0 a 5 personas",1,0)),
                            per_ocu_6a10 = as.factor(ifelse(per_ocu=="6 a 10 personas",1,0)),
                            per_ocu_11a30 = as.factor(ifelse(per_ocu=="11 a 30 personas",1,0)),
                            per_ocu_31a50 = as.factor(ifelse(per_ocu=="31 a 50 personas",1,0)),
                            per_ocu_101a250 = as.factor(ifelse(per_ocu=="101 a 250 personas",1,0))) %>% select(-per_ocu)
```

```{r}
datos_regresion %<>% mutate(Apodaca=as.factor(ifelse(municipio=="Apodaca",1,0)),
                            Escobedo=as.factor(ifelse(municipio=="General Escobedo",1,0)),
                            Guadalupe=as.factor(ifelse(municipio=="Guadalupe",1,0)),
                            Monterrey=as.factor(ifelse(municipio=="Monterrey",1,0)),
                            SalinasV=as.factor(ifelse(municipio=="Salinas Victoria",1,0)),
                            San_Nicolas=as.factor(ifelse(municipio=="San Nicolás de los Garza",1,0)),
                            San_Pedro=as.factor(ifelse(municipio=="San Pedro Garza García",1,0)),
                            Santa_Catarina=as.factor(ifelse(municipio=="Santa Catarina",1,0)),
                            Santiago=as.factor(ifelse(municipio=="Santiago",1,0))) %>% select(-municipio)
```

### *Incorporando datos de fuentes secundarias*
\
Usaremos datos de DENUE de previas actividades para complementar la base de datos.
\
```{r}
datos_nuevos <- readxl::read_xlsx("/Users/carolina/Library/CloudStorage/GoogleDrive-a01720509@tec.mx/Shared drives/Planeación estratégica/Reto/Análisis DENUE/nuevo_leon.xlsx")
  
datos_nuevos %<>%mutate(cve_mun = ifelse(nchar(cve_mun)==2,paste0("0",cve_mun),
                                          ifelse(nchar(cve_mun)==1,paste0("00",cve_mun),cve_mun)))
```

```{r}
datos_nuevos <-  merge(datos_regresion,datos_nuevos, by.x="cve_mun", by.y="cve_mun",all.x=TRUE) 
```

### *Selección de variables*
\

#### Correlación

\
Haciendo una matríz de correlación con los datos transformados y los datos de fuente secundarias, tenemos 2 principales hallazgos. Las variables que más afectan las ventas de un peddio son la categorías de los productos en una orden. En segundo lugar, podemos observar que, como era esperado existen altos niveles de correlación entre las variables independientes. Esto afectará de manera negativa el modelo.
\
```{r}
cor <- datos_nuevos %>% select(-cve_mun,-id_pedido,-id_cliente,-cantidad_pedido)
cor <- model.matrix(~0+., data=cor) 
cor <- round(cor(cor),4)
corrplot::corrplot(cor,method = 'color', order = 'original',
         tl.srt=90,tl.col="black",cl.pos = 'b', addgrid.col = 'white', tl.cex = 0.55)
```

#### Usando AIC y LM
\
Como la correlación no fue muy útil para la selección de variables usaremos una regresión lineal con selección de variables según el AIC más bajo.
\
```{r}
set.seed(123123)
split = caTools::sample.split(datos_nuevos$ventas_pedido, SplitRatio = 0.8)
train_set = subset(datos_nuevos, split == F) 
test_set = subset(datos_nuevos, split == T)
rm(split)
```

El modelo que selecciona usa las categorías de alimento, la cantidad de unidades en el pedido y 3 categorías de per_ocu
\
```{r}
set.seed(123)
lm <- lm(ventas_pedido~., train_set) %>%  MASS::stepAIC(trace = F)
summary(lm)

```
Para hacer uso de los datos externos, incluiremos la población del 2022 y el porcentaje de pobreza extrema.
\
```{r}
modelo <- ventas_pedido ~ cantidad_pedido + normal_preparado + 
    congelado_animal + normal_queso + normal_sazón + normal_vegetal + 
    normal_liquido + congelado_preparado + normal_animal + per_ocu_0a5 + 
    per_ocu_6a10 + per_ocu_11a30 +poblacion_2022 + porcentaje_pob_pobreza_ext
```

### *Modelos*

\

#### Support Vector Machine

\
```{r}
set.seed(123)
svm <- e1071::svm(modelo, train_set,type = 'eps-regression',kernel = 'radial')
summary(svm)
```

#### Random Forest

\
```{r}
set.seed(1234)
rf = randomForest::randomForest(modelo,data=train_set, ntree = 500, importance = TRUE)
rf
```

### *Selección del Modelo*
\
Usaremos el RMSE para la selección del modelo. Comparando el SVM, el RF y el LM que se usó para la selección de las variables, el LM es el modelo con un menor RMSE. Es importante volver a mencionar que los datos están correlacionados, por lo que sería una buena opción explorar otros métodos de predicción para así tener un modelo más preciso.
\
```{r}
lmpred = predict(lm, newdata = test_set)
lmp <- Metrics::rmse(test_set$ventas_pedido, lmpred)
svmpred = predict(svm, newdata = test_set)
svmp <- Metrics::rmse(test_set$ventas_pedido, svmpred)
rfpred = predict(rf, newdata = test_set)
rfp <- Metrics::rmse(test_set$ventas_pedido, rfpred)
(comp <- data.frame(Modelo=c("LM","SVM","RF"),RMSE=c(lmp,svmp,rfp)) %>% rmarkdown::paged_table())
```

## <u>Series de Tiempo</u>
\
Para el escenario a tres años de las ventas, se transformaron los datos a una serie de tiempo trimestral esto se hizo sumando el total de las 30,000 órdenes a lo largo del tiempo. Empezando con el T1 del 2020 y terminando con el T1 del 2023. Después de esto se hizo una prueba de estacionariedad y se encontró que los datos no son estacionarios. Para la proyección se usó un modelo ARIMA y a continuación podemos observar los datos históricos y la predicción. 
\

### *Transformación de Datos*
\
Sumaremos las ventas para hacer una serie de tiempo a nivel trimestre.
\
```{r}
st <- datos_regresion %>% 
  mutate(Q =lubridate::date(zoo::as.yearqtr(fechapedido, format = "%Y-%Q"))) %>% 
  select(Q,ventas_pedido) %>%
  group_by(Q) %>% summarise(Ventas = sum(ventas_pedido)) %>% ungroup() %>% mutate(Tipo = as.factor("Histórico"))
ventas_st<-ts(data=st$Ventas,frequency=4,start=c(2020,1),end=c(2023,1))
```
### *Estacionalidad* 
\
Revisando la estacionalidad, podemos ver que el  p-value es mayor a 0.05 por lo que los datos no son estacionarios
\
```{r}
adf.test(st$Ventas) 
```
## <u>Modelo</u>
\
Usaremos un modelo auto arima.
\
```{r}
modelo<-auto.arima(ventas_st,d=1)
```
## <u>Pronóstico</u>

\
Haremos un prónostico de los datos a 3 años, por lo que se predicirán 12 periodos.
\
```{r}
forecast1 <- forecast(modelo, h = 12)
```

Se hará un gráfico de escenarios optimistas y pesimistas con intervalos de confianza del 80% y 95%.
\
```{r}
start_date <- lubridate::yq("2023 Q2")
end_date <- lubridate::yq("2026 Q1")
forecast <- as.data.frame(forecast1)
Q <- seq(lubridate::yq("2023 Q2"), lubridate::yq("2026 Q1"), by = "3 months")
lo80 <- forecast %>% select(`Lo 80`) %>%  mutate(Tipo = as.factor("Pronóstico")) %>% rename(Ventas = `Lo 80`) 
hi80 <- forecast %>%select(`Hi 80`) %>%  mutate(Tipo = as.factor("Pronóstico")) %>% rename(Ventas = `Hi 80`) 
lo95 <- forecast %>%select(`Lo 95`) %>%  mutate(Tipo = as.factor("Pronóstico")) %>% rename(Ventas = `Lo 95`) 
hi95 <- forecast %>%select(`Hi 95`) %>%  mutate(Tipo = as.factor("Pronóstico")) %>% rename(Ventas = `Hi 95`) 

lo80 <- cbind(Q,lo80) 
hi80 <- cbind(Q,hi80)
lo95 <- cbind(Q,lo95)
hi95 <- cbind(Q,hi95)

lo80 <- rbind(st,lo80) 
hi80 <- rbind(st,hi80)
lo95 <- rbind(st,lo95)
hi95 <- rbind(st,hi95)

```

Es importante resaltar que está serie de tiempo es un resumen de los datos creado por nosotras y que no toma en cuenta cualquier otro dato, por lo que la predicción no es la más precisa. Esto se evidencia en los 4 posibles escenarios. Usando intervalos de confianza del 80% y 95% para escenarios pesimistas y optimistas, vemos que los pronósticos son o muy altos o muy bajos, según el escenario. 
\
```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 16-19.** Escenarios de Predicción'}
l8 <- ggplot(lo80,aes(x=Q,y=Ventas,color=Tipo)) + geom_line(size=0.8) +  geom_point(size=1.2)+ theme_light() + theme(legend.position = "",plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(labels = scales::comma)  +  ggtitle("80 Pesimista")  +xlab("")+ylab("") + scale_color_manual(values = colores)  
 
  
h8 <- ggplot(hi80,aes(x=Q,y=Ventas,color=Tipo))  + geom_line(size=0.8) +  geom_point(size=1.2)+ theme_light() + theme(legend.position = "",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(labels = scales::comma)  +
  ggtitle("80 Optimista")  +xlab("")+ylab("") + scale_color_manual(values = colores)  
 
l9 <- ggplot(lo95,aes(x=Q,y=Ventas,color=Tipo))  + geom_line(size=0.8) +  geom_point(size=1.2)+ theme_light() + theme(legend.position = "",plot.title = element_text(hjust = 0.5))+scale_y_continuous(labels = scales::comma)  +
  ggtitle("95 Pesimista")  +xlab("")+ylab("") + scale_color_manual(values = colores)  
 
h9 <- ggplot(hi95,aes(x=Q,y=Ventas,color=Tipo))+ geom_line(size=0.8) +  geom_point(size=1.2)+ theme_light() + theme(legend.position = "",plot.title = element_text(hjust = 0.5))+ scale_y_continuous(labels = scales::comma)  +
  ggtitle("95 Optimista")  +xlab("")+ylab("") + scale_color_manual(values = colores)  
 
cowplot::plot_grid(l8,l9,h8,h9)
```

Aquí podemos ver esto resumido con el promedio de los pronósticos, el cual es el mismo número para cada valor pronosticado. 
\
```{r fig.align='center', out.width='85%',fig.cap='**Gráfico 20.** Escenarios de Predicción'}
options(scipen = 999)
plot(forecast1,main="Promedio de Escenarios")
```



# **Análisis de Fuentes Externas**
\
  Dado que nuestra meta es la expansión, un factor esencial a considerar es el comportamiento externo de la empresa. En otras palabras, como esta la industria en la que participa, que mercado atiende, cuál es la demanda y oferta actual y potencial de crecimiento dentro de la misma.  
\
  Para esto, se utilizó la base de datos del **Directorio Estadístico Nacional de Unidades Económicas (DENUE)** del 2023 de comercio al por mayor de abarrotes, alimentos, bebidas, hielo y tabaco y datos de reportes del **INEGI** y **ENIGH**. Todos los insights encontrados se complementarán con los insights internos para la creación de estrategias de expansión que abarque las necesidades y cumpla con los objetivos de **S&A**. 
\
```{r}
denue <- read_excel("/Users/carolina/Library/CloudStorage/GoogleDrive-a01720509@tec.mx/Shared drives/Planeación estratégica/Reto/Análisis DENUE/INEGI_DENUE_23052023/INEGI_DENUE.xlsx")
```

### <u>Limpieza</u>
\
```{r}
glimpse(denue)
```

```{r}
# cambio de nombre de las variables
colnames(denue) <- c("ID", "Clee", "Unidad_Economica", "Razon_Social", "Codigo_Actividad", "NClase_Actividad", "Personal_Ocupado", "TVialidad", "NVialidad", "TVialidad1", "NVialidad1", "TVialidad2", "NVialidad2", "TVialidad3", "NVialidad3", "NExteriorKM", "Letra_Exterior", "Edificio", "Edificio_Piso", "Num_Interior", "Letra_Interior", "Tipo_Asentamiento", "Nombre_Asentamiento", "Tipo_CentroComercial", "Categoría_Centro", "Num_Local", "CP", "CVE_Entidad", "Entidad", "CVE_Municipio", "Municipio", "CVE_Localidad", "Localidad", "Area_Geoestadistica", "Manzana", "Telefono", "Correo", "SitioWeb", "Tipo_Establecimiento", "Latitud", "Longitud", "Fecha_IncorporacionDENUE")
```

```{r}
denue  %<>%  dplyr::select(-Clee, -TVialidad1, -NVialidad1, -TVialidad2, -NVialidad2, -TVialidad3, -NVialidad3, -NExteriorKM, -Letra_Exterior,
                           -Edificio_Piso, -Num_Interior, -Letra_Interior, -Num_Local, -CP, -Telefono, -Correo, -SitioWeb, -Fecha_IncorporacionDENUE)
```

```{r}
factores <- c("Unidad_Economica","Razon_Social","NClase_Actividad","Personal_Ocupado","TVialidad","Tipo_Asentamiento","Nombre_Asentamiento",
              "Tipo_CentroComercial","Entidad","Municipio","Localidad","Area_Geoestadistica","Tipo_Establecimiento")
denue[factores] <- lapply(denue[factores], as.factor)
```

### <u>Actividades más relevantes</u>
\
Las actividades más relevantes son:
\
- Comercio al por mayor de frutas y verduras frescas (29%) 
\
- Comercio al por mayor de abarrotes (13%) 
\
- Comercio al por mayor de carne de aves (10%) 
\
- Comercio al por mayor de carnes rojas (9%) 
\
- Comercio al por mayor de semillas y granos alimenticios, especias y chiles secos (6%) 
\
Las actividades menos relevantes son:
\
- Comercio al por mayor de cigarros, puros y tabaco (0.44%)
\
- Comercio al por mayor de conservas alimenticias (1.18%)
\
- Comercio al por mayor de pescados y mariscos (1.40%) 
\
- Comercio al por mayor de pan y pasteles (1.48%) 
\
- Comercio al por mayor de huevo (1.62%) 
\
```{r}
table_nclass <- table(denue$NClase_Actividad)
percentage <- prop.table(table_nclass) * 100
sorted_percentage <- sort(percentage, decreasing = TRUE)
```

### <u>Top municipios</u>
\
Top de municipios por clase de actividad
\
- San Nicolas de los Garza (39%)
\
- Monterrey (23%)
\
- Guadalupe (10%)
\
- Apodaca (6.5%)
\
- Santa Catarina (3.7%)
\
- General Escobedo ()
\

```{r fig.align='center', warning=FALSE, out.width='85%',fig.cap='**Gráfico 21.** Municipios con Mayor Actividad'}
denue %>% count(NClase_Actividad, Municipio) %>% arrange(desc(n)) %>%
  slice_head(n = 25) %>% #selecciona las primeras 10 filas del dataframe después de ordenarlo por frecuencia descendente
  ggplot(mapping = aes(x = reorder(Municipio, -n), y = n)) + geom_line(size=1,color="#A6BAF2",fill= "#A6BAF2")+
  geom_point(size = 3, shape = 21, color = "#7494EA", fill = "#5E83E8") + theme_light() +
  ggtitle("Top municipios por clase de actividad") + xlab("") +  ylab("") +theme(plot.title = element_text(hjust = 0.5))
```

```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>% count(Municipio) %>%
  mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n))  %>% rmarkdown::paged_table()
```


```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>% count(Municipio) %>%
  mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n))  %>% rmarkdown::paged_table()
```


#### San Nicolás de los Garza
\
En san nicolás el top de actividades son las siguientes:
\
- Comercio al por mayor de frutas y verduras frescas (65%)
\
- Comercio al por mayor de semillas y granos alimenticios, especias y chiles secos (7%)
\
Las actividades menos relevantes son las siguientes:
\
- Comercio al por mayor de vinos y licores (0.94%)
\
- Comercio al por mayor de conservas alimenticias (0.94%)
\
```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>%  filter(Municipio=="San Nicolas de los Garza") %>% 
  count(NClase_Actividad) %>% mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n))  %>% rmarkdown::paged_table()
```

#### Monterrey
\
En Monterrey las actividades más relevantes son las siguientes:
\
- Comercio al por mayor de carnes rojas (14%)
\
- Comercio al por mayor de abarrotes (13.3%)
\
- Comercio al por mayor de carne de aves (10%)
\
Las actividades menos relevantes son las siguientes:
\
- Comercio al por mayor de huevo (1.3%)
\
- Comercio al por mayor de cigarros, puros y tabaco (1.6%)
\
```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>%  filter(Municipio=="Monterrey") %>%
  count(NClase_Actividad) %>% mutate(Frecuencia = scales::percent( n /sum(n))) %>%arrange(desc(n))  %>% rmarkdown::paged_table()
```

#### Guadalupe
\
En Guadalupe las actividades más relevantes son los siguientes:
\
- Comercio al por mayor de carnes rojas (20.43%)
\
- Comercio al por mayor de carne de aves (17.5%)
\
- Comercio al por mayor de abarrotes (16.78%)
\
- Comercio al por mayor de dulces y materias primas para reposterÌa (10.2%)
\
Las actividades menos relevantes son las siguientes:
\
- Comercio al por mayor de conservas alimenticias (0.7%)
\
- Comercio al por mayor de huevo (1.4%)
\
```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>% filter(Municipio=="Guadalupe") %>% 
  count(NClase_Actividad) %>%  mutate(Frecuencia = scales::percent( n /sum(n))) %>%  arrange(desc(n))  %>% rmarkdown::paged_table()
```

#### Apodaca
\
En Apodaca las actividades más relevantes son las siguientes:
\
- Comercio al por mayor de carne de aves (17.9%)
\
- Comercio al por mayor de abarrotes (13.4%)
\
- Comercio al por mayor de carnes rojas (11.2%)
\
- Comercio al por mayor de otros alimentos (11.2%)
\
Las actividades menos relevantes son las siguientes:
\
- Comercio al por mayor de vinos y licores	 (1.12%)	
\
- Comercio al por mayor de huevo	(1.12%)			
\
```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>%  filter(Municipio=="Apodaca") %>% 
  count(NClase_Actividad) %>% mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n))  %>% rmarkdown::paged_table()
```

#### Santa Catarina
\
En Santa Catarina las actividades más relevantes son las siguientes:
\
- Comercio al por mayor de abarrotes	(25%)
\
- Comercio al por mayor de carne de aves	(15.6%)
\
Las actividades menos relevantes son las siguientes:
\
- Comercio al por mayor de semillas y granos alimenticios, especias y chiles secos	(1.9%)
\
- Comercio al por mayor de pescados y mariscos	(1.9%)
\
```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>%  filter(Municipio=="Santa Catarina") %>%
  count(NClase_Actividad) %>% mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n))  %>% rmarkdown::paged_table()
```

#### Escobedo
En Escobedo las actividades más relevantes son las siguientes:
\
- Comercio al por mayor de carne de aves	(26.6%)
\
- Comercio al por mayor de abarrotes	(13.3%)
\
- Comercio al por mayor de bebidas no alcohólicas y hielo	(11.11%)
\
Las actividades menos relevantes son las siguientes:
\
- Comercio al por mayor de semillas y granos alimenticios, especias y chiles secos	(2.2%)
\
- Comercio al por mayor de embutidos	(2.2%)
\
```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio) %>%  filter(Municipio=="General Escobedo") %>%
  count(NClase_Actividad) %>% mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n)) %>% rmarkdown::paged_table()
```


### <u>Tipo Centro Comercial</u>
\
El 64.2% de los registros sobre el tipo de centro comercial/establecimiento no tiene algún tipo de clasificación, mientras que el 30.9% es de la Central de abastos.
\
```{r fig.align='center'}
denue %>% select(NClase_Actividad, Municipio, Tipo_CentroComercial)%>% 
  count(Tipo_CentroComercial) %>% mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n))  %>% rmarkdown::paged_table()
```

### <u>Competidores</u>
\
Por último, los principales comercios que tienen actividad de comercio al por mayor en la industria de abarrotes, alimentos, bebidas, hielo y tabaco no tienen como tal una clasificación con el 32% siendo la clasificación con mayor porcentaje y por consiguiente con un 4.07% **AVIPECUARIA MARLAN SA DE CV** dedicada al comercio al por mayor de carne de aves.
\
```{r fig.align='center'}
denue %>%select(Razon_Social) %>% count(Razon_Social) %>%
  mutate(Frecuencia = scales::percent( n /sum(n))) %>% arrange(desc(n))  %>% rmarkdown::paged_table()
```


# **Selección de Clientes Prospectos**
\
```{r}
prospectos <- read_csv("/Users/carolina/Library/CloudStorage/GoogleDrive-a01720509@tec.mx/Shared drives/Planeación estratégica/Reto/Data/Prospectos/prospectos.csv")
```
Estos son los datos disponibles de los clientes prospectos 
\
-**lat y long**: latitdud y longitud
\
-**nombre_act, nom_estab y raz_social**: Nombre del negocio, su actividad y su razón social
\
-**per_ocu**: La ocupación de cada cliente
\
-**tipo_vial, nom_vial**: Información de la ubicación (tipo de calle y nombre de la calle)
\
-**edificio, edificio_e**: Información de la ubicación
\
-**tipo_asent, nomb_Asent**: Información de la ubicación
\
-**tipoCenCom, nom_CenCom, num_local**: Información de la ubicación si está en un centro comercial
\
-**cod_postal,cve_ent,entidad**: Información de la ubicación, estado en el que está
\
-**cve_mun,municipio**: Muncipio en el que está
\
- **cve_loc,localidad, ageb, AGEB_int, manzana**: Información de la ubicación
\
- **fecha_alta**: fecha de alta del negocio 
\
## <u>Limpieza de datos</u>
 Se borran las siguientes variables debido a la gran cantidad de NAs que tienen 
 \
```{r}
prospectos %<>% select(-raz_social,-edificio,-edificio_e,-tipoCenCom,-nom_CenCom,
                       -num_local,-tipo_vial,-nom_vial,-nomb_asent)
```

## <u>Arreglando Factores y Fechas</u>
\
Arregla
```{r}
# FACTORES
factores <- c("entidad","municipio","localidad","nombre_act","per_ocu","tipoUniEco")
prospectos[factores] <- lapply(prospectos[factores], as.factor)
# FECHAS
prospectos %<>% dplyr::mutate(año_alta = as.factor(substr(prospectos$fecha_alta, 0, 4)),
                              mes_alta = as.factor(substr(prospectos$fecha_alta, 6, 7)))
```

## <u>Creción de nuevas variables</u>
\

### *Tamaño de la empresa*

\
```{r fig.align='center'}
prospectos %<>% mutate(tamaño = forcats::fct_collapse(prospectos$per_ocu,
                                             "Micro" =  c("0 a 5 personas"),
                                            "Pequeña" =  c("6 a 10 personas","11 a 30 personas" ),
                                            "Mediana" =  c("31 a 50 personas","51 a 100 personas"),
                                            "Grande" =  c("101 a 250 personas","251 y más personas")))
table(prospectos$per_ocu ,prospectos$tamaño)
```

### *Nombre de la actividad por negocio *
\
```{r}
prospectos %<>%  mutate(actividad_original = nombre_act) #Cambiamos el nombre para mantener la original 
prospectos %<>% 
  mutate(nombre_act = forcats::fct_collapse(prospectos$actividad_original,
                                             "Alojamientos" =  c("Cabañas, villas y similares","Campamentos y albergues recreativos",
                                                                 "Departamentos y casas amueblados con servicios de hotelería",
                                                                 "Hoteles con otros servicios integrados",
                                                                 "Hoteles sin otros servicios integrados","Moteles",
                                                                 "Pensiones y casas de huéspedes"),
                                             "Cafeterías" = c("Cafeterías, fuentes de sodas, neverías, refresquerías y similares",
                                                              "CafeterÌas, fuentes de sodas, neverÌas, refresquerÌas y similares"),
                                             "Centros nocturnos" = c("Centros nocturnos, discotecas y similares",
                                                                     "Bares, cantinas y similares"),
                                             "Restaurantes a la carta" = c("Restaurantes con servicio de preparación de alimentos a la carta o de comida corrida"),
                                             "Restaurantes de antojitos" =  c("Restaurantes con servicio de preparación de antojitos",
                                                                              "Restaurantes con servicio de preparaciÛn de antojitos"),
                                             "Restaurantes de pescados y mariscos" = c("Restaurantes con servicio de preparación de pescados y mariscos",
                                                                                       "Restaurantes con servicio de preparaciÛn de pescados y mariscos"),
                                             "Restaurantes de comida rapida" = c("Restaurantes con servicio de preparación de pizzas,
                                                                                 hamburguesas, hot dogs y pollos rostizados para llevar",
                                                                                 "Restaurantes con servicio de preparaciÛn de pizzas, 
                                                                                 hamburguesas, hot dogs y pollos rostizados para llevar"),
                                             "Restaurantes de tacos y tortas" = c("Restaurantes con servicio de preparación de tacos y tortas",
                                                                                  "Restaurantes con servicio de preparaciÛn de tacos y tortas"),
                                             "Restaurantes de autoservicio" = c("Restaurantes de autoservicio"),
                                             "Restaurantes para llevar" = c("Restaurantes que preparan otro tipo de alimentos para llevar"),
                                             "Servicios de comedor para empresas" = c("Servicios de comedor para empresas e instituciones"),
                                             "Servicios de preparación de alimentos" = c("Servicios de preparación de alimentos en unidades móviles","
                                                                                         Servicios de preparación de alimentos para ocasiones especiales",
                                                                                         "Servicios de preparación de otros alimentos para consumo inmediato",
                                                                                         "Servicios de preparaciÛn de otros alimentos para consumo inmediato")))
table(prospectos$nombre_act)
```

### *Agrupación por Negocio* 
\
Tenemos 5 actividades: **Restaurantes -  Cafeterías - Servicios - Centros nocturnos - Alojamientos**
\
De estas 5 el portafolio de clientes solo se centra en restuantes y alojamiento. En base a la agrupacion y arreglo anterior, granulamos el analisis y manetenemos 5 categorias.

```{r}
prospectos %<>% mutate(actividad = forcats::fct_collapse(prospectos$nombre_act,
                                             "Restaurantes" =  c("Restaurantes de antojitos","Restaurantes de comida rapida",
                                                                 "Restaurantes de autoservicio","Restaurantes a la carta",
                                                                 "Restaurantes de pescados y mariscos",
                                                                 "Restaurantes de tacos y tortas","Restaurantes para llevar"),
                                             "Alojamientos" = c("Alojamientos"),
                                             "Servicios" = c("Servicios de preparación de alimentos","Servicios de comedor para empresas"),
                                             "Centros nocturnos" = c("Centros nocturnos"),
                                             "Cafeterías" =  c("Cafeterías")))  

```




## <u>Analisis Exploratorio (Consultas)</u>
```{r}
skimr::skim(prospectos)
```

###  *Top 10 prospectos por municipios*
```{r fig.align='center'}
sqldf('SELECT municipio, COUNT(municipio) AS n
      FROM prospectos
      GROUP BY municipio
      ORDER BY n DESC
      LIMIT 10')
```
### *Cantidad de prospectos por actividad*
```{r fig.align='center'}
sqldf('SELECT actividad, COUNT(actividad) AS n
      FROM prospectos
      GROUP BY actividad
      ORDER BY n DESC')
```
### *Tipo de establecimeientos por actividad *
```{r fig.align='center'}
sqldf('SELECT nombre_act, actividad, COUNT(nombre_act) AS n
      FROM prospectos
      GROUP BY nombre_act, actividad
      ORDER BY n DESC')
```
### *Ver que alojamientos escoger*
```{r fig.align='center'}
sqldf('SELECT actividad_original, actividad, COUNT(actividad) AS n
      FROM prospectos
      WHERE actividad = "Alojamientos"
      GROUP BY actividad_original, actividad
      ORDER BY n DESC')
```
### *Ver que restarurante escogemos*
```{r fig.align='center'}
sqldf('SELECT nombre_act, actividad, COUNT(actividad) AS n
      FROM prospectos
      WHERE actividad = "Restaurantes"
      GROUP BY nombre_act, actividad
      ORDER BY n DESC')
```



## <u>Eligiendo prospectos</u>
\
Para la propuestas de ganancia de cuota de mercado, estaremos recomendando prospectos en base a las necesidades, facilidades del SF. Dado a esto utilizamos el metodo de eliminacion donde en base a filtros vamos granulando las especificaciones de los propesctos que queremos seleccionar.   

### *Filtros por Ubicación*
\
Queremos que todos los prospectos esten en Nuevo León

```{r}
elegidos <- prospectos %>% filter(entidad != "EDOMEX") #9960 Obs
```
Queremos que todos los prospectos esten cerca de la CEDIS ubicada en el centro de MTY. Queremos crecer de adentro hacia afuera por lo que nos concentraremos en el municipio de Monterrey
\
```{r}
# coordenadas del negocio son: 25.680189, -100.306491
elegidos %<>% filter( municipio == "Monterrey" ) #3157 Obs
```

### *Filtros por tipo de negocio*
\
Queremos que todos los prospectos sean Restaurantes y/o Alojamientos
\
```{r}
# Queremos que todos los prospectos sean Restaurantes y/o Alojamientos
elegidos %<>% filter(actividad == "Restaurantes" | actividad == "Alojamientos" ) #2413 Obs
```

- Queremos que todos los prospectos de Alojamientos sean:
\
  - Hoteles con otros servicios integrados 
\
  - Departamentos y casas amueblados con servicios de hotelería 
\
- Queremos que todos los prospectos de Restaurantes sean:
\
  - Hoteles con otros servicios integrados 78
\
  - Departamentos y casas amueblados con servicios de hotelería
\
```{r}
elegidos %<>% filter(actividad_original == "Hoteles con otros servicios integrados" | 
                     actividad_original == "Departamentos y casas amueblados con servicios de hotelería" |
                     nombre_act == "Restaurantes de tacos y tortas" | nombre_act == "Restaurantes a la carta" ) 
```
 Queremos que los prospectos sean empresas con tamaño de 0 a 5 personas, de 11 a 30 personas y de 51 a 100 personas
 \
```{r}
elegidos %<>% filter(per_ocu == "6 a 11 personas" |per_ocu == "11 a 30 personas" | per_ocu == "51 a 100 personas") 
```

Queremos que los prospectos sean empresas con fecha de alta mayor al 2015
\
```{r}
elegidos %<>% filter(año_alta%in%c("2016","2017","2018","2019","2020","2021","2022"))
```
### *Tipo de Centro Comercial*
\
Queremos que los prospectos sean empresas ubicadas en un centro comercial fijo  
\
```{r}
elegidos %<>% filter(tipoUniEco == "Fijo") #
```


## <u>Final</u>
\
Estos son los prospectos elegidos.
\
```{r}
skimr::skim(elegidos)
```


# **Referencias**
\
- Secretaría de Economía de los Países Bajos. (2021). *Coyuntura económica - III trimestre 2021*. Recuperado de http://datos.nl.gob.mx/portfolio_page/coyuntura-economica-iii-trimestre-2021/ 
\
- Scherer, C. (2023). *A ggplot2 Tutorial for Beautiful Plotting in R*. Recuperado de
https://cedricscherer.netlify.app/2019/08/05/a-ggplot2-tutorial-for-beautiful-plotting-in-r/

- ChatGPT, Comunicación personal, (Mayo 2023)
```{r include=FALSE}
rm(list=ls())
#https://rpubs.com/cvelarde/1047907
```


```{r include=FALSE,echo=FALSE}
ggplot() +
  geom_sf(data = clientes_mty2) + 
  geom_point(data = clientes, aes(x = long, y = lat, color = Estatus), size = 5,alpha=1)+
  labs(title="Tipo de Cliente\n")+
  theme_void() +  
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
    theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "top",
        plot.title = element_text(hjust = 0.5))  + scale_color_manual(values = n2) 

#25.680189, -100.306491
```

