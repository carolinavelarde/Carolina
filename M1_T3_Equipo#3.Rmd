---
title: 'Modelos de Regresión Espacial y Machine Learning'
date: '`r Sys.Date()`'
output: 
  html_document:
    theme: lumen
    code_folding: show
    toc: TRUE
    toc_depth: 2
    number_sections: FALSE
    toc_float:
      smooth_scroll: TRUE
      collapsed: FALSE
editor_options: 
  chunk_output_type: inline
---

**Equipo #3:**

* Carolina Velarde Díaz A01720509
* Chantal Aimeé Simó García A00827554
* Kízari Hernández Huerta A00828451
* Ximena Araceli Martínez Flores A00829670

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(devtools,tidyverse,knitr,skimr,readxl,dplyr,magrittr,writexl,lubridate,ggplot2,sf,treemap,d3r,htmltools,rgeos,maptools,sp,maps,spdep,MASS,spmoran,spatialreg,coda,sphet,ggmap,mapproj,RColorBrewer,ggsn,rlang,tigris,leaflet,classInt,rgeoda,gridExtra,grid,summarytools,googledrive,tmap,rgdal,mapview,GWmodel,regclass,viridis,GGally)
thematic::thematic_rmd()
```

## Objetivo

Mediante la estimación de diferentes modelos de regresión predecir los factores asociados con el incremento/disminución de casos confirmados de Covid-19 a nivel municipal para el caso de México durante el período 2020–2021.

## Situación problema

De acuerdo a la Cámara Nacional de la Industria Farmacéutica (CANIFARMA), en México las personas en situación de pobreza se caracterizan por tener una probabilidad 5 veces mayor de fallecer por COVID-19 que las personas con relativamente mayor nivel de ingresos (Arceo-Gómez, et al., 2021). Además de la falta de acceso a servicios de salud y posibles cormobilidades, otro factor relevante en incrementar dicha probabililidad es el perfil socioeconómico (Arceo-Gómez, et al., 2021).

A partir de la pandemia por COVID-19, la firma de consultoría XYZ (México) establece que *las organizaciones que su principal actividad de negocios es brindar servicios de salud requiren soluciones específicas e innovadoras, para aprovechar oportunidades, afrontar retos, así como favorecer su consolidación y crecimiento*. Algunos de los servicios enfocados por parte de la firma es detectar las necesidades y potencial del crecimiento del sector salud a partir de la analítica de datos.

<hr>

## Análisis Espacial Exploratorio de Datos

## {.tabset}

### Limpieza de datos

#### Carga de datos

```{r message=FALSE, warning=FALSE}
covid19<-read_csv('~/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/spda_covid19/covid19_confirmados.csv')
denue_hosp<-read_excel('~/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/spda_covid19/denue_hospitales.xlsx')
```

#### Cambio de tipo de datos

```{r message=FALSE, warning=FALSE}
denue_hosp$id<-as.character(denue_hosp$id)
denue_hosp$codigo_act<-as.character(denue_hosp$codigo_act)
denue_hosp$cod_postal<-as.character(denue_hosp$cod_postal)
denue_hosp<-denue_hosp%>%
  separate(col=fecha_alta,into=c('anio','mes'),sep='-')
denue_hosp$anio<-as.numeric(denue_hosp$anio)
denue_hosp$mes<-as.numeric(denue_hosp$mes)
denue_hosp<-denue_hosp%>%
  mutate(fecha_alta1=make_date(anio,mes))
```

```{r}
denue_hosp<-denue_hosp[,c('id','clee','cve_ent','entidad','cve_mun','municipio','cve_loc','localidad','per_ocu','nom_estab','raz_social','codigo_act','nombre_act','tipo_vial','nom_vial','tipo_asent','tipoCenCom','cod_postal','ageb','manzana','latitud','longitud','fecha_alta1')]
denue_hosp<-denue_hosp%>%
  rename(fecha_alta=fecha_alta1)
```

#### Sustitución de caracteres especiales

```{r message=FALSE, warning=FALSE}
denue_hosp<-as.data.frame(denue_hosp)
denue_hosp$localidad<-gsub('¡','A',denue_hosp$localidad)
denue_hosp$localidad<-gsub('·','a',denue_hosp$localidad)
denue_hosp$localidad<-gsub('Û','o',denue_hosp$localidad)
denue_hosp$localidad<-gsub('Ì','i',denue_hosp$localidad)
denue_hosp$localidad<-gsub('È','e',denue_hosp$localidad)
denue_hosp$localidad<-gsub('Ò','n',denue_hosp$localidad)
denue_hosp$localidad<-gsub('˙','u',denue_hosp$localidad)
```

```{r}
denue_hosp$municipio<-gsub('¡','A',denue_hosp$municipio)
denue_hosp$municipio<-gsub('·','a',denue_hosp$municipio)
denue_hosp$municipio<-gsub('Û','o',denue_hosp$municipio)
denue_hosp$municipio<-gsub('Ì','i',denue_hosp$municipio)
denue_hosp$municipio<-gsub('È','e',denue_hosp$municipio)
denue_hosp$municipio<-gsub('Ò','n',denue_hosp$municipio)
denue_hosp$municipio<-gsub('˙','u',denue_hosp$municipio)
```

```{r}
denue_hosp$nombre_act<-gsub('¡','A',denue_hosp$nombre_act)
denue_hosp$nombre_act<-gsub('·','a',denue_hosp$nombre_act)
denue_hosp$nombre_act<-gsub('Û','o',denue_hosp$nombre_act)
denue_hosp$nombre_act<-gsub('Ì','i',denue_hosp$nombre_act)
denue_hosp$nombre_act<-gsub('È','e',denue_hosp$nombre_act)
denue_hosp$nombre_act<-gsub('Ò','n',denue_hosp$nombre_act)
denue_hosp$nombre_act<-gsub('˙','u',denue_hosp$nombre_act)
```

```{r}
denue_hosp$nom_vial<-gsub('”','O',denue_hosp$nom_vial)
denue_hosp$nom_vial<-gsub('¡','A',denue_hosp$nom_vial)
denue_hosp$nom_vial<-gsub('…','E',denue_hosp$nom_vial)
denue_hosp$nom_vial<-gsub('Û','o',denue_hosp$nom_vial)
denue_hosp$nom_vial<-gsub('—','N',denue_hosp$nom_vial)
denue_hosp$nom_vial<-gsub('Ì','i',denue_hosp$nom_vial)
denue_hosp$nom_vial<-gsub('Õ','I',denue_hosp$nom_vial)
denue_hosp$nom_vial<-toupper(denue_hosp$nom_vial)
```

```{r}
denue_hosp$nom_estab<-gsub('”','O',denue_hosp$nom_estab)
denue_hosp$nom_estab<-gsub('¡','A',denue_hosp$nom_estab)
denue_hosp$nom_estab<-gsub('…','E',denue_hosp$nom_estab)
denue_hosp$nom_estab<-gsub('Û','o',denue_hosp$nom_estab)
denue_hosp$nom_estab<-gsub('—','N',denue_hosp$nom_estab)
denue_hosp$nom_estab<-gsub('Ì','i',denue_hosp$nom_estab)
denue_hosp$nom_estab<-gsub('Õ','I',denue_hosp$nom_estab)
denue_hosp$nom_estab<-toupper(denue_hosp$nom_estab)
```

```{r}
denue_hosp$raz_social<-gsub('”','O',denue_hosp$raz_social)
denue_hosp$raz_social<-gsub('¡','A',denue_hosp$raz_social)
denue_hosp$raz_social<-gsub('…','E',denue_hosp$raz_social)
denue_hosp$raz_social<-gsub('Û','o',denue_hosp$raz_social)
denue_hosp$raz_social<-gsub('—','N',denue_hosp$raz_social)
denue_hosp$raz_social<-gsub('Ì','i',denue_hosp$raz_social)
denue_hosp$raz_social<-gsub('Õ','I',denue_hosp$raz_social)
denue_hosp$raz_social<-toupper(denue_hosp$raz_social)
```

#### Eliminación de categorías

Como siguiente paso en la limpieza de datos, se descartarán todos los centros alcohólicos, albergues, centros familiares, entre otros, que no tengan impacto significativo en este análisis.

```{r}
ca<-list('alcholicos','alchol','alchoholicos','alcoholcos','alcoholico','alcohoicos','alcohocentral','alcohlicos','alcohicos','alcohokicos','alcoholico','alcoholcos','alcoholicoa','alcoholicoos','alcoholicosanonimos','alcoholios','alcoholiocs','alcoholismo','alcoholismos','alcoholismoy','alcoholoicos','alcoholocos','alcoihilicos','alcoholoicos','alcolicos','alcoholoicos','alcoholismoy','alcolicos','alcolicos','alcolicos','alcolismo','alcoolicos','alcholicos','anonimos','alcoholicos','anon','anninimos','alcoh0licos','alcohilicos','alcohnilico','algoholico','alcohnilicos','aninimos','drogadictos','anomimos','anonomos','anoninos','alcoh0licos','alcohnilicos','algoholico','AL ANON AC','AL-ANON','A.A','alanon')
fam<-list('fam','familiar','familia','joven','jovenes','adolescente','mujer','infantil','dif','familiares')
alb<-list('albergue','albergues','casa hogar','casa','hogar')
denue_hosp$raz_social<-gsub('AL ANON','alchol',denue_hosp$raz_social)
denue_hosp$raz_social<-gsub('AL-ANON','alchol',denue_hosp$raz_social)
```

```{r}
denue_hosp%<>%
  mutate(AA=ifelse(grepl(paste(ca,collapse='|'), denue_hosp$raz_social,ignore.case=TRUE)==TRUE,1,0),
         Centro_Fam=ifelse(grepl(paste(fam, collapse='|'),denue_hosp$raz_social,ignore.case=TRUE)==TRUE,1,0),
         Albergue=ifelse(grepl(paste(alb, collapse='|'),denue_hosp$raz_social,ignore.case=TRUE)==TRUE,1,0)) 
denue_hosp%<>%
  mutate(Categoria=as.factor(ifelse(AA==1, 'AA',ifelse(Centro_Fam==1,'Centro_Fam',ifelse(Albergue==1,'Albergue','Otro')))))%>%
  dplyr::select(-AA,-Centro_Fam,-Albergue)
```

En resumen, se eliminaron 25,587 centros. La nueva base de datos cuenta con 208,716 registros.

```{r}
denue_hosp%>%count(Categoria,sort=TRUE)
```

```{r}
denue_hosp%<>%filter(Categoria=='Otro') %>% dplyr::select(-Categoria)
```

Como se puede observar a continuación, la base de datos ahora cuenta con 16 variables de tipo de dato caracter, 1 variable de tipo de dato fecha y 6 variables de tipo de dato numérico.

```{r}
skim(denue_hosp)
```

#### Creación de clave y unión de bases de datos

Para hacer unión de las bases de datos, se multiplicó la variable `cve_ent` por 1,000 y se sumó con la variable `cve_mun`.

```{r}
denue_hosp%<>%mutate(cve_ent=(cve_ent*1000)+cve_mun)%>%group_by(cve_ent,entidad)%>%count()%>%rename(Hospitales=n)
covid_hospital<-merge(covid19,denue_hosp,by='cve_ent',all=TRUE)
covid_hospital%<>%filter(!is.na(mpio))
```

### Creación y selección de variables de interés

Las variables a analizar son:

1. **Tasa de casos confirmados de Covid-19**
2. **Pobreza**
3. **Densidad de población**
4. **Porcentaje de Poblacion con Acceso a Servicios de Salud**
5. **Hospitales**

```{r}
covid_hospital%<>%mutate(Covid_2021=jan_2021+feb_2021+mar_2021+april_2021+may_2021+
           june_2021+july_2021+august_2021+sept_2021+oct_2021+nov_2021+dic_2021)%>%
  dplyr::select(-feb_2020,-march_2020,-april_2020,-may_2020,-june_2020,-july_2020, -august_2020,-sept_2020,-oct_2020,-nov_2020,-dic_2020, -hogrem2015,-porcentaje_pob_servicios_salud,-hogremjefmuj2015,-crimen_2018,-porcentaje_pob_pobreza_ext,-pob_6_14_no_edu,-feb_2021,-mar_2021,-april_2021,-may_2021,-june_2021,-july_2021,-august_2021,-sept_2021,-oct_2021,-nov_2021,-dic_2021,-jan_2021)
covid_hospital%<>%rename(Pobreza=porcentaje_pob_pobreza,Acceso_SS=porcentaje_pob_acceso_ss,Densidad_2020=popden2020,Poblacion=poblacion_2022)
```

Como siguiente paso, se hizo conversión de las variables porcentuales a decimales.

```{r message=FALSE, warning=FALSE}
num<-c('Pobreza','Acceso_SS','Densidad_2020')
covid_hospital[num]<-lapply(covid_hospital[num],as.double)
covid_hospital[num]<-lapply(covid_hospital[num]/100,as.double)
```

Se crea la variable `Region` con las 4 distintas regiones de México (Centro, Centro Norte, Sur y Norte).

```{r}
covid_hospital%<>%mutate(Region=as.factor(ifelse(entidad%in%c('Ciudad de Mexico', 'Mexico','Guanajuato','Hidalgo','Morelos','Puebla','Queretaro','Tlaxcala'),'Centro',ifelse(entidad%in%c('Aguascalientes','Baja California Sur','Colima','Durango','Jalisco','Michoacan','Michoacan de Ocampo', 'Nayarit','San Luis Potosi', 'Sinaloa', 'Zacatecas'),'Centro Norte',ifelse(entidad%in%c('Campeche','Chiapas','Guerrero','Oaxaca','Quintana Roo','Tabasco','Veracruz','Yucatan'),'Sur',ifelse(entidad%in%c('Baja California','Chihuahua','Coahuila', 'Nuevo Leon','Sonora','Tamaulipas' ),'Norte','Otro'))))))%>%filter(!(Region == 'Otro'))
unique(covid_hospital$Region)
```

Después, se renombraron las variables de interés.

```{r}
covid_hospital<-rename(covid_hospital,IDUNICO=cve_ent,Municipio=mpio,Crimen_2019=crimen_2019,Inclusion_2019=inclusion_fin_2019,Rezago_Social=rezago_social,Grado_RS=grado_rs,Entidad=entidad)
```

Como se muestra a continuación, se eliminaron las variables de poco valor al análisis.

```{r}
covid_hospital<-dplyr::select(covid_hospital,-popnoafmed2015,-gini2015)
```

Finalmente, se muestra la base de datos que se estará analizando.

```{r}
str(covid_hospital)
```


### Estadísticos descriptivos

#### Distribución de casos Covid-19

Aquí se muestra un *treemap* con la distribución de casos confirmados de Covid-19 en las diferentes regiones, entidades y municipios de México.

```{r message=FALSE, warning=FALSE}
t<-treemap::treemap(covid_hospital,
            #data
            index=c('Region','Entidad','Municipio'),
            vSize='Covid_2021',
            type='index',
            
            # Main
            title='Distribución de Covid-19 2021',
            palette='Set3',
            mapping=NA,

            # Borders:
            border.col=c('black'),             
            border.lwds=1,
           
            # Labels
            fontsize.labels=10,
            fontcolor.labels='black',
            fontface.labels=1,
            bg.labels=0,
            align.labels=c('left','top'),                                  
            overlap.labels=0.5,
            inflate.labels=T)
```

```{r}
devtools::install_github('timelyportfolio/d3treeR',force=TRUE)
d3treeR::d3tree2(t,rootname='General')
```

#### Comportamiento de casos Covid-19

Aquí se observa la cantidad de casos de Covid-19 confirmados por región. Al igual que en el `treemap` la región del Centro cuenta con el mayor % de casos confirmados en la república, seguido de las regiones Centro Norte, Sur y Norte.

```{r}
bb<-ggplot(covid_hospital,aes(x=Region,y=Covid_2021,fill=Region)) +
  geom_col(width=1.5)+theme_light()+labs(title="Cantidad de casos confirmados Covid-19 por Región",x=" ",y=" ")+theme(panel.spacing=unit(0.1, "lines"),axis.ticks.y=element_blank(),axis.text.y=element_blank())+scale_fill_brewer(palette="Set3") 
plotly::ggplotly(bb)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
covid_hospital1<-read_csv('/Users/kizarihdz/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/khh/khh_covid_hospital.csv')
covid_hospital2<-merge(covid_hospital,covid_hospital1,by='IDUNICO',all=TRUE)
covid_hospital2<-dplyr::select(covid_hospital2,-Municipio.y,-Poblacion.y,-Densidad_2020.y,-Crimen_2019.y,-Inclusion_2019.y,-Pobreza.y,-Rezago_Social.y,-Grado_RS.y,-Hospitales.y,-Covid_2021.y,-Region.y)
names(covid_hospital2)[names(covid_hospital2) == 'Municipio.x'] <- 'Municipio'
names(covid_hospital2)[names(covid_hospital2) == 'Poblacion.x'] <- 'Poblacion'
names(covid_hospital2)[names(covid_hospital2) == 'Densidad_2020.x'] <- 'Densidad_2020'
names(covid_hospital2)[names(covid_hospital2) == 'Crimen_2019.x'] <- 'Crimen_2019'
names(covid_hospital2)[names(covid_hospital2) == 'Inclusion_2019.x'] <- 'Inclusion_2019'
names(covid_hospital2)[names(covid_hospital2) == 'Pobreza.x'] <- 'Pobreza'
names(covid_hospital2)[names(covid_hospital2) == 'Rezago_Social.x'] <- 'Rezago_Social'
names(covid_hospital2)[names(covid_hospital2) == 'Grado_RS.x'] <- 'Grado_RS'
names(covid_hospital2)[names(covid_hospital2) == 'Hospitales.x'] <- 'Hospitales'
names(covid_hospital2)[names(covid_hospital2) == 'Covid_2021.x'] <- 'Covid_2021'
names(covid_hospital2)[names(covid_hospital2) == 'Region.x'] <- 'Region'
covid_hospital2<-dplyr::select(covid_hospital2,-Acceso_SS,-Covid_2021)
glimpse(covid_hospital2)
centro<-covid_hospital2%>%dplyr::filter(Region=='Centro')
```

Después, se muestra un resumen estadístico a nivel nacional.

```{r message=FALSE, warning=FALSE}
summarytools::descr(covid_hospital2)
```

#### Matriz de correlación

Ahora, en la siguiente matriz se puede visualizar la relación entre las múltiples variables y los patrones y diferencias entre las cuatro regiones.

Con respecto a la correlación de la tasa de casos confirmados de Covid-19 con las demás variables, se evidencia que con la `Poblacion`, `Hospitales` y `Densidad` la correlación es altamente significativa, con 78%, 75% y 67% respectivamente.

```{r message=FALSE, warning=FALSE}
covid_hospital2<-covid_hospital2%>% 
  relocate(IDUNICO,Region,Entidad,Municipio, .before = everything())
ggpairs(covid_hospital2,columns = 5:14,ggplot2::aes(colour=Region),progress=FALSE)
```

#### Histogramas

* El porcentaje de acceso a servicios de salud es alto y similar a nivel nacional como nivel región centro, rondando entre el 80%-90%.
* La población en pobreza es alta y similar a nivel nacional como nivel región centro, rondando entre el 50%-100%.

```{r message=FALSE, warning=FALSE}
accss_global<-ggplot(covid_hospital2,aes(Accceso_SS))+geom_histogram(color='black',fill='#07529C')+theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Nacional')+xlab('')+ylab('')
accss_reg<-ggplot(centro,aes(Accceso_SS))+geom_histogram(color='black',fill='#43AD77') +theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Región Centro')+xlab('')+ylab('')
pobr_global<-ggplot(covid_hospital2,aes(Pobreza))+geom_histogram(color='black',fill='#07529C') +theme_light()+labs(title='Pobreza',subtitle='Nivel Nacional')+xlab('')+ ylab('')
pobr_reg<-ggplot(centro,aes(Pobreza))+geom_histogram(color='black',fill='#43AD77') +theme_light()+labs(title='Pobreza',subtitle='Región Centro')+xlab('')+ ylab('')
cowplot::plot_grid(accss_global,accss_reg,pobr_global,pobr_reg,ncol=2)
```

* La cantidad de hospitales, tanto a nivel nacional como nivel región centro, es baja (0-100).
* La tasa de casos confirmados de Covid-19, tanto a nivel nacional como nivel región centro, es baja (0-500).

```{r message=FALSE, warning=FALSE}
hosp_global<-ggplot(covid_hospital2,aes(Hospitales))+geom_histogram(color='black',fill='#07529C')+theme_light()+labs(title='Hospitales',subtitle='Nivel Nacional')+xlab('')+ylab('')
hosp_reg<-ggplot(centro,aes(Hospitales))+geom_histogram(color='black',fill='#43AD77')+theme_light()+labs(title='Hospitales',subtitle='Nivel Región Centro')+xlab('')+ylab('') 
cov_global<-ggplot(covid_hospital2,aes(Tasa_Covid19_2021))+geom_histogram(color='black',fill='#07529C')+theme_light()+labs(title='Tasa de casos confirmados de Covid-19',subtitle='Nivel Nacional')+xlab('')+ylab('')
cov_reg<-ggplot(centro,aes(Tasa_Covid19_2021))+geom_histogram(color='black',fill='#43AD77') +theme_light()+labs(title='Tasa de casos confirmados de Covid-19',subtitle='Nivel Región Centro')+xlab('')+ylab('')
cowplot::plot_grid(hosp_global,hosp_reg,cov_global,cov_reg,ncol=2)
```

* La densidad de población, tanto a nivel nacional como nivel región centro, es baja (0-100).

```{r}
den_global<-ggplot(covid_hospital2,aes(Densidad_2020))+geom_histogram(color='black',fill='#07529C')+theme_light()+labs(title='Densidad de Población',subtitle='Nivel Nacional')+xlab('')+ylab('')
den_reg<-ggplot(centro,aes(Densidad_2020))+geom_histogram(color='black',fill='#43AD77') +theme_light()+labs(title='Densidad de Población',subtitle='Nivel Región Centro')+xlab('')+ylab('')
cowplot::plot_grid(den_global,den_reg,ncol=2)
```



#### Gráficos de dispersión

Ahora, respecto a la relación entre las variables seleccionadas y la tasa de casos confirmados de Covid-19, se evidencia lo siguiente:

* La relación entre el porcentaje de población con acceso a servicios de salud y los casos confirmados de Covid-19, tanto a nivel nacional como nivel región centro, es negativa, esto significa que entre mayores son las cantidades de casos de Covid-19, menor es el porcentaje de población con acceso a servicios de salud.
* La relación entre la población en pobreza y la tasa de casos confirmados de Covid-19, tanto a nivel nacional como nivel región centro, es negativa, esto significa que entre mayores son las cantidades de casos de Covid-19, menor es la cantidad de población en pobreza.

```{r message=FALSE, warning=FALSE}
cov_acc_gl<-ggplot(covid_hospital2,aes(x=Tasa_Covid19_2021,y=Accceso_SS))+geom_point(size=1.5,shape=21,color='black',fill='#07529C')+theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Nacional')+ylab('')+xlab('Covid-19')
cov_acc_reg<-ggplot(centro,aes(x=Tasa_Covid19_2021,y=Accceso_SS))+geom_point(size=1.5,shape=21,color='black',fill='#43AD77')+theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Región Centro')+ylab('')+xlab('Covid-19')
cov_pobr_gl<-ggplot(covid_hospital2,aes(x=Tasa_Covid19_2021,y=Pobreza))+geom_point(size=1.5,shape=21,color='black',fill='#07529C')+theme_light()+labs(title='Población en Pobreza',subtitle='Nivel Nacional')+ylab('')+xlab('Covid-19')
cov_pobr_reg<-ggplot(centro,aes(x=Tasa_Covid19_2021,y=Pobreza))+geom_point(size=1.5,shape=21,color='black',fill='#43AD77')+theme_light()+labs(title='Población en Pobreza',subtitle='Nivel Región Centro')+ylab('')+xlab('Covid-19')
cowplot::plot_grid(cov_acc_gl,cov_acc_reg,cov_pobr_gl,cov_pobr_reg,ncol=2)
```

* La relación entre la cantidad de hospitales y los casos confirmados de Covid-19, tanto a nivel nacional como nivel región centro, es negativa, esto significa que entre mayores son las cantidades de casos de Covid-19, menor es la cantidad de hospitales disponibles.
* La relación entre la densidad de población y los casos confirmados de Covid-19, tanto a nivel nacional como nivel región centro, es negativa, esto significa que entre mayores son las cantidades de casos de Covid-19, menor es la densidad de población.

```{r message=FALSE, warning=FALSE}
cov_hosp<-ggplot(covid_hospital2,aes(x=Tasa_Covid19_2021,y=Hospitales))+geom_point(size=1.5, shape=21,color='black',fill='#07529C')+theme_light()+labs(title='Hospitales',subtitle='Nivel Nacional')+ylab('')+xlab('Covid-19')
cov_hosp_reg<-ggplot(centro,aes(x=Tasa_Covid19_2021,y=Hospitales))+geom_point(size=1.5,shape=21,color='black',fill='#43AD77')+theme_light()+labs(title='Hospitales',subtitle='Nivel Región Centro')+ylab('')+xlab('Covid-19')
cov_den<-ggplot(covid_hospital2,aes(x=Densidad_2020,y=Hospitales))+geom_point(size=1.5, shape=21,color='black',fill='#07529C')+theme_light()+labs(title='Densidad de Población',subtitle='Nivel Nacional')+ylab('')+xlab('Covid-19')
cov_den_reg<-ggplot(centro,aes(x=Densidad_2020,y=Hospitales))+geom_point(size=1.5,shape=21,color='black',fill='#43AD77')+theme_light()+labs(title='Densidad de Población',subtitle='Nivel Región Centro')+ylab('')+xlab('Covid-19')
cowplot::plot_grid(cov_hosp,cov_hosp_reg,cov_den,cov_den_reg,ncol=2)
```

### Estadísticos de dispersión

#### Diagramas de caja

* La dispersión de los datos en el porcentaje de población con acceso a servicios de salud, tanto a nivel nacional como nivel región centro, es similar, abarcan un rango muy amplio, es decir, pueden variar drásticamente, además de evidenciarse gran cantidad de valores atípicos.
* La dispersión de los datos de la población en pobreza, tanto a nivel nacional como nivel región centro, es similar, abarcan un rango muy amplio, es decir, pueden variar drásticamente. Se visualiza poca presencia de valores atípicos.

```{r message=FALSE, warning=FALSE}
viol_ass<-ggplot(covid_hospital2,aes(y=Accceso_SS))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Nacional')+xlab('')+ylab('')
viol_ass_reg<-ggplot(centro,aes(y=Accceso_SS))+geom_boxplot(color='black',fill='#43AD77',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Región Centro')+xlab('')+ylab('')
viol_pobr<-ggplot(covid_hospital2,aes(y=Pobreza))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Población en Pobreza 2022',subtitle='Nivel Nacional')+xlab('')+ylab('')
viol_pobr_reg<-ggplot(centro,aes(y=Pobreza))+geom_boxplot(color='black',fill='#43AD77',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Población en Pobreza 2022',subtitle='Nivel Región Centro')+xlab('')+ylab('')
cowplot::plot_grid(viol_ass,viol_ass_reg,viol_pobr,viol_pobr_reg,ncol=2)
```

* La dispersión de los datos en la cantidad de hospitales, tanto a nivel nacional como nivel región centro, es similar, la mayoría se encuentran por arriba de la mediana, además de evidenciarse gran cantidad de valores atípicos.
* La dispersión de los datos en la tasa de casos confirmados de Covid-19, tanto a nivel nacional como nivel región centro, es similar, la mayoría se encuentran por arriba de la mediana, además de evidenciarse gran cantidad de valores atípicos.

```{r message=FALSE, warning=FALSE}
viol_hosp<-ggplot(covid_hospital2,aes(y=Hospitales))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Hospitales',subtitle='Nivel Nacional')+xlab('')+ylab('')
viol_hosp_reg<-ggplot(centro,aes(y=Hospitales))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Hospitales',subtitle='Nivel Región Centro')+xlab('')+ylab('')
viol_covid<-ggplot(covid_hospital2,aes(y=Tasa_Covid19_2021))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Tasa de casos confirmados de Covid-19',subtitle='Nivel Nacional')+xlab('')+ylab('')
viol_covid_reg<-ggplot(centro,aes(y=Tasa_Covid19_2021))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Tasa de casos confirmados de Covid-19',subtitle='Nivel Región Centro')+xlab('')+ylab('')
cowplot::plot_grid(viol_hosp,viol_hosp_reg,viol_covid,viol_covid_reg,ncol=2)
```

* La dispersión de los datos en la densidad de población a nivel nacional se evidencia gran cantidad de valores atípicos.
* La dispersión de los datos en la densidad de población a nivel región centro, se observa que la mayoría de los datos se encuentran por arriba de la mediana, además de evidenciarse gran cantidad de valores atípicos.

```{r}
viol_den<-ggplot(covid_hospital2,aes(y=Densidad_2020))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Densidad de Población',subtitle='Nivel Nacional')+xlab('')+ylab('')
viol_den_reg<-ggplot(centro,aes(y=Tasa_Covid19_2021))+geom_boxplot(color='black',fill='#07529C',notch=TRUE)+scale_x_continuous(breaks=NULL)+theme_light()+labs(title='Densidad de Población',subtitle='Nivel Región Centro')+xlab('')+ylab('')
cowplot::plot_grid(viol_den,viol_den_reg,ncol=2)
```


#### QQ-Plots

* La distribución de los datos del porcentaje de población con acceso a servicios de salud, tanto a nivel nacional como a nivel región centro, es similar, cuando ya no están sobre la línea punteada significa que los datos del porcentaje de población con acceso a servicios de salud tienen cuantiles más bajos que los esperados.
* La distribución de los datos del porcentaje de población en pobreza, tanto a nivel nacional como a nivel región centro, es similar al inicio, es decir, los datos esperados compaten con los observados, sin embargo, cuando ya no están sobre la línea punteada significa que los datos de población en pobreza tienen cuantiles más bajos que los esperados.

```{r message=FALSE, warning=FALSE}
qq_ass<-ggplot(covid_hospital2,aes(sample=Accceso_SS))+geom_qq(fill='black',colour='#07529C')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Nacional')+xlab('')+ylab('')
qq_ass_reg<-ggplot(centro,aes(sample=Accceso_SS))+geom_qq(fill='black',colour='#43AD77')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Porcentaje de Población con Acceso a Servicios de Salud',subtitle='Nivel Región Centro') +xlab('')+ ylab('')
qq_pobr<-ggplot(covid_hospital2,aes(sample=Pobreza))+geom_qq(fill='black',colour='#07529C')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Porcentaje de Población en Pobreza',subtitle='Nivel Nacional')+xlab('')+ylab('')
qq_pobr_reg<-ggplot(centro,aes(sample=Pobreza))+geom_qq(fill='black',colour='#43AD77')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Porcentaje de Población en Pobreza',subtitle='Nivel Región Centro') +xlab('')+ ylab('')
cowplot::plot_grid(qq_ass,qq_ass_reg,qq_pobr,qq_pobr_reg,ncol=2)
```

* La distribución de los datos de la cantidad de hospitales, tanto a nivel nacional como a nivel región centro, es similar, cuando ya no están sobre la línea punteada significa que los datos de la cantidad de hospitales tienen cuantiles más altos que los esperados.
* La distribución de los datos de la tasa de casos confirmados de Covid-19, tanto a nivel nacional como a nivel región centro, es similar al inicio, es decir, los datos esperados compaten con los observados, sin embargo, cuando ya no están sobre la línea punteada significa que los datos de la tasa de casos confirmados tienen cuantiles más altos que los esperados.

```{r message=FALSE, warning=FALSE}
qq_hosp<-ggplot(covid_hospital2,aes(sample=Hospitales))+geom_qq(fill='black',colour='#07529C')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Hospitales',subtitle='Nivel Nacional')+xlab('')+ylab('')
qq_hosp_reg<-ggplot(centro,aes(sample=Hospitales))+geom_qq(fill='black',colour='#43AD77')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Hospitales',subtitle='Nivel Región Centro') +xlab('')+ ylab('')
qq_covid<-ggplot(covid_hospital2,aes(sample=Tasa_Covid19_2021))+geom_qq(fill='black',colour='#07529C')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Tasa de casos confirmados de Covid-19',subtitle='Nivel Nacional')+xlab('')+ylab('')
qq_covid_reg<-ggplot(centro,aes(sample=Tasa_Covid19_2021))+geom_qq(fill='black',colour='#43AD77')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Tasa de casos confirmados de Covid-19',subtitle='Nivel Región Centro') +xlab('')+ ylab('')
cowplot::plot_grid(qq_hosp,qq_hosp_reg,qq_covid,qq_covid_reg,ncol=2)
```

* La distribución de los datos de la densidad de población, tanto a nivel nacional como a nivel región centro, es similar al inicio, es decir, los datos esperados compaten con los observados, sin embargo, cuando ya no están sobre la línea punteada significa que los datos de la densidad de población tienen cuantiles más altos que los esperados.

```{r}
qq_den<-ggplot(covid_hospital2,aes(sample=Densidad_2020))+geom_qq(fill='black',colour='#07529C')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Densidad de Población',subtitle='Nivel Nacional')+xlab('')+ylab('')
qq_den_reg<-ggplot(centro,aes(sample=Densidad_2020))+geom_qq(fill='black',colour='#43AD77')+geom_qq_line(linetype='dashed',color='black')+theme_light()+labs(title='Densidad de Población',subtitle='Nivel Región Centro') +xlab('')+ ylab('')
cowplot::plot_grid(qq_den,qq_den_reg,ncol=2)
```



### Distribución espacial

#### Regiones y Entidades

```{r message=FALSE, warning=FALSE}
map_datab<-read_sf('/Users/kizarihdz/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/datos_act3/mx_geo_data.shp')
colores<-colorRampPalette(c('#184E77','#1E6091','#1A759F','#168AAD','#34A0A4','#52B69A','#76C893','#99D98C'))(8)
glimpse(map_datab)
```

A continuación se muestra la división por regiones de México.

```{r}
ggplot(data=map_datab)+geom_sf(aes(fill=region),linetype=0.75,lwd=0.25)+theme_light()+ggtitle(label='Distribución Espacial')+theme(legend.position='bottom')+scale_fill_manual(values=colores)
```

#### Covid-19

Después, se muestra la tasa de casos confirmados de Covid-19 en el año 2021, la mayoría de los estados tienen pocos casos confirmados, sin embargo, en el centro se visualiza una mayor concentración de los mismos.

```{r}
ggplot(data=map_datab)+geom_sf(aes(fill=tasa_covid),linetype=0.75,lwd=0.25)+scale_fill_gradient(low='#99D98C',high='#184E77')+theme_light()+ggtitle(label='Tasa de Casos Confirmados de Covid-19 2021')+theme(legend.position='bottom')
```

#### Pobreza

En el siguiente mapa, se muestra la pobreza en la población, la mayoría de los estados tienen un porcentaje alto de población en pobreza, sin embargo, entre más al norte menos es la pobreza en la población.

```{r}
ggplot(data=map_datab)+geom_sf(aes(fill=pobreza),linetype=0.75,lwd=0.25)+scale_fill_gradient(low='#99D98C',high='#184E77')+theme_light()+ggtitle(label='Población en Pobreza')+theme(legend.position='bottom')
```

#### Densidad de Población

En el siguiente mapa, se muestra la densidad de población, la mayoría de los estados tienen mínima densidad de población.

```{r}
ggplot(data=map_datab)+geom_sf(aes(fill=densidad_2),linetype=0.75,lwd=0.25)+scale_fill_gradient(low='#99D98C',high='#184E77')+theme_light()+ggtitle(label='Densidad de Población')+theme(legend.position='bottom')
```

#### Porcentaje de Población con Acceso a Servicios de Salud

En el siguiente mapa, se muestra el porcentaje de población con acceso a servicios de salud, la mayoría de los estados tienen un porcentaje alto, sin embargo, se puede visualizar que al norte del país el porcentaje es bajo.

```{r}
ggplot(data=map_datab)+geom_sf(aes(fill=acceso_ss),linetype=0.75,lwd=0.25)+scale_fill_gradient(low='#99D98C',high='#184E77')+ theme_light()+ggtitle(label='Porcentaje de Población con Acceso a Servicios de Salud')+theme(legend.position='bottom')
```

#### Hospitales

En el siguiente mapa, se muestra la cantidad de hospitales, se puede apreciar que en la mayoría de los estados hay una mínima cantidad de estos, sin embargo, se puede visualizar en estados dispersos que algunos cuentan con cantidades altas.

```{r}
ggplot(data=map_datab)+geom_sf(aes(fill=hospitales),linetype=0.75,lwd=0.25)+scale_fill_gradient(low='#99D98C',high='#184E77')+ theme_light()+ggtitle(label='Hospitales')+theme(legend.position='bottom')
```

### Matrices de conectividad espacial y modelización de vecinos espaciales

```{r message=FALSE, warning=FALSE}
mex_mpios_shp<-readOGR(dsn='/Users/kizarihdz/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/datos_act3/mx_geo_data.shp')
```

```{r message=FALSE, warning=FALSE}
mex_mpios_shp_alt<-readOGR(dsn='/Users/kizarihdz/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/datos_act3/mx_geo_data.shp')
```

#### Enfoque `queen`

```{r}
swm_queen<-poly2nb(mex_mpios_shp,queen=TRUE)
```

A continuación se aprecia la matriz de conectividad de `queen`, misma que representa la relación de vecindad entre los estados de México.

```{r message=FALSE, warning=FALSE}
#plot(mex_mpios_shp,borders='#184E77',axes=FALSE,las=1) 
#plot(swm_queen,coordinates(mex_mpios_shp),pch=19,cex=0.6,add=TRUE,col='#99D98C')
#title('Queen Contiguity',cex.main=0.9)
```

#### Enfoque `rook`

```{r}
swm_rook<-poly2nb(mex_mpios_shp,queen=FALSE)
```

De manera similar se visualiza la matriz de conectividad de `rook`.

```{r message=FALSE, warning=FALSE}
#plot(mex_mpios_shp,borders='#184E77',axes=FALSE,las=1) 
#plot(swm_rook,coordinates(mex_mpios_shp),pch=19,cex=0.6,add=TRUE,col='#99D98C')
#title(main='Rook Contiguity',cex.main=0.9)
```

#### K-Nearest Neighbor (KNN)

Por consiguiente, se normalizan las matrices anteriores (`W` significa ponderada) para poder asignar mayor importancia (pesos) a los vecinos más cercanos que a los lejanos.

```{r}
rswm_queen<-nb2listw(swm_queen,style='W',zero.policy=TRUE)
rswm_rook<-nb2listw(swm_rook,style='W',zero.policy=TRUE)
```


Después, se realiza el cálculo de las ponderaciones espaciales basadas en la distancia `k-nearest neighbor (knn)`

Se obtienen las coordenadas de latitud y longitud de cada municipio en México.

```{r}
coords<-coordinates(mex_mpios_shp)
```

En promedio, cada estado está más cerca en distancia de otros 123 puntos.

Tomando en cuenta la distancia `knn`, la mayor distancia de primer vecino más cercano es de 229.364 km, por lo que, usar esto como banda superior/umbral da la certeza de que todas las unidades tendrán al menos 1 vecino, debido a que es la distancia máxima.

```{r}
knn1<-knn2nb(knearneigh(coords))
knn1_dist<-unlist(nbdists(knn1,coords,longlat=TRUE))
summary(knn1_dist)
dwm<-dnearneigh(coords,0,99,longlat=TRUE)
dwm
```

```{r message=FALSE, warning=FALSE}
#plot(mex_mpios_shp,border='#184E77')
#plot(dwm,coords,add=TRUE,pch=19,cex=0.6)
#title(main='Neighbours within 99 km',cex.main=0.9)
```

### Autocorrelación espacial

#### Covid-19

```{r message=FALSE, warning=FALSE}
mex_mpios_shp$sp_tasa_covid<-lag.listw(rswm_queen,mex_mpios_shp$tasa_covid,zero.policy=TRUE)
```

La tasa de casos confirmados de Covid-19 presenta un rezago espacial, es decir, la autocorrelación que se produce entre municipios cercanos, se puede explicar por la distancia entre estos.

```{r}
qtm(mex_mpios_shp,fill="sp_tasa_covid")
#mapview(mex_mpios_shp,zcol='sp_tasa_covid')
```

Dado a que el p-value es positivo, se concluye que hay evidencia de autocorrelación espacial significativa en la tasa de casos confirmados de Covid-19. Esto sugiere que los valores similares de la tasa de casos confirmados de Covid-19 están agrupados en el espacio, lo que puede ser indicativo de patrones de dependencia espacial.

##### Prueba I de Moran bajo aleatorización

```{r}
moran.test(mex_mpios_shp$tasa_covid,listw=rswm_queen,zero.policy=TRUE,na.action=na.omit)
```

##### Correlograma I de Moran

En el siguiente correlograma se puede probar la presencia de heterogeneidad en los datos, lo que indica que hay patrones de autocorrelación espacial que varían en función de la distancia.

```{r}
Moran_Correlogram_covid<-sp.correlogram(swm_queen,mex_mpios_shp$tasa_covid,order=6,method='I',style='B')
plot(Moran_Correlogram_covid)
```

#### Pobreza

```{r}
mex_mpios_shp$sp_pobreza<-lag.listw(rswm_queen,mex_mpios_shp$pobreza,zero.policy=TRUE)
```

La población en pobreza presenta un rezago espacial, es decir, la autocorrelación que se produce entre municipios cercanos, se puede explicar por la distancia entre estos.

```{r}
qtm(mex_mpios_shp,fill="sp_pobreza")
#mapview(mex_mpios_shp,zcol='sp_pobreza')
```

##### Prueba I de Moran bajo aleatorización

Dado a que el p-value es positivo, se concluye que hay evidencia de autocorrelación espacial significativa en la población en pobreza. Esto sugiere que los valores similares de la población en pobreza están agrupados en el espacio, lo que puede ser indicativo de patrones de dependencia espacial.

```{r}
moran.test(mex_mpios_shp$pobreza,listw=rswm_queen,zero.policy=TRUE,na.action=na.omit)
```

##### Correlograma I de Moran

En el siguiente correlograma se puede probar la presencia de heterogeneidad en los datos, lo que indica que hay patrones de autocorrelación espacial que varían en función de la distancia.

```{r message=FALSE, warning=FALSE}
Moran_Correlogram_pobreza<-sp.correlogram(swm_queen,mex_mpios_shp$pobreza,order=6,method='I',style='B')
plot(Moran_Correlogram_pobreza)
```

#### Densidad de Población

```{r}
mex_mpios_shp$sp_densidad_2<-lag.listw(rswm_queen,mex_mpios_shp$densidad_2,zero.policy=TRUE)
```

La densidad de población presenta un rezago espacial, es decir, la autocorrelación que se produce entre municipios cercanos, se puede explicar por la distancia entre estos.

```{r}
qtm(mex_mpios_shp,fill="sp_densidad_2")
#mapview(mex_mpios_shp,zcol='sp_densidad_2')
```

##### Prueba I de Moran bajo aleatorización

Dado a que el p-value es positivo, se concluye que hay evidencia de autocorrelación espacial significativa en la densidad de población. Esto sugiere que los valores similares de la densidad de población están agrupados en el espacio, lo que puede ser indicativo de patrones de dependencia espacial.

```{r}
moran.test(mex_mpios_shp$densidad_2,listw=rswm_queen,zero.policy=TRUE,na.action=na.omit)
```

##### Correlograma I de Moran

En el siguiente correlograma se puede probar la presencia de heterogeneidad en los datos, lo que indica que hay patrones de autocorrelación espacial que varían en función de la distancia.

```{r}
Moran_Correlogram_den<-sp.correlogram(swm_queen,mex_mpios_shp$densidad_2,order=6,method='I',style='B')
plot(Moran_Correlogram_den)
```

#### Porcentaje de Población con Acceso a Servicios de Salud

```{r}
mex_mpios_shp$sp_acceso_ss<-lag.listw(rswm_queen,mex_mpios_shp$acceso_ss,zero.policy=TRUE)
```

La población con acceso a servicios de salud presenta un rezago espacial, es decir, la autocorrelación que se produce entre municipios cercanos, se puede explicar por la distancia entre estos.

```{r}
qtm(mex_mpios_shp,fill="sp_acceso_ss")
#mapview(mex_mpios_shp,zcol='sp_acceso_ss')
```

##### Prueba I de Moran bajo aleatorización

Dado a que el p-value es positivo, se concluye que hay evidencia de autocorrelación espacial significativa en la población con acceso a servicios de salud. Esto sugiere que los valores similares de la población con acceso a servicios de salud están agrupados en el espacio, lo que puede ser indicativo de patrones de dependencia espacial.

```{r}
moran.test(mex_mpios_shp$acceso_ss,listw=rswm_queen,zero.policy=TRUE,na.action=na.omit)
```

##### Correlograma I de Moran

En el siguiente correlograma se puede probar la presencia de heterogeneidad en los datos, lo que indica que hay patrones de autocorrelación espacial que varían en función de la distancia.

```{r}
Moran_Correlogram_ass<-sp.correlogram(swm_queen,mex_mpios_shp$sp_acceso_ss,order=6,method='I',style='B')
plot(Moran_Correlogram_ass)
```


#### Hospitales

```{r}
mex_mpios_shp$hospitales<-as.numeric(mex_mpios_shp$hospitales)
mex_mpios_shp$sp_hospitales<-lag.listw(rswm_queen,mex_mpios_shp$hospitales,zero.policy=TRUE)
```

La cantidad de hospitales presenta un rezago espacial, es decir, la autocorrelación que se produce entre municipios cercanos, se puede explicar por la distancia entre estos.

```{r}
qtm(mex_mpios_shp,fill="sp_hospitales")
#mapview(mex_mpios_shp,zcol='sp_hospitales')
```

##### Prueba I de Moran bajo aleatorización

Dado a que el p-value es positivo, se concluye que hay evidencia de autocorrelación espacial significativa en la cantidad de hospitales. Esto sugiere que los valores similares de la cantidad de hospitales están agrupados en el espacio, lo que puede ser indicativo de patrones de dependencia espacial.

```{r}
moran.test(mex_mpios_shp$hospitales,listw=rswm_queen,zero.policy=TRUE,na.action=na.omit)
```

##### Correlograma I de Moran

En el siguiente correlograma se puede probar la presencia de heterogeneidad en los datos, lo que indica que hay patrones de autocorrelación espacial que varían en función de la distancia.

```{r}
Moran_Correlogram_hosp<-sp.correlogram(swm_queen,mex_mpios_shp$sp_hospitales,order=6,method='I',style='B')
plot(Moran_Correlogram_hosp)
```

<hr>

## Modelos de regresión

## {.tabset}

### Selección de variables

```{r message=FALSE, warning=FALSE, include=FALSE}
base<-read.csv('~/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/datos_act3/covid_hospital.csv')
```

Se utiliza `lm` para escoger las variables significativas.

```{r include=FALSE}
base$pobreza[which(is.na(base$pobreza))]=0.6195 # 1 NAs
base$acceso_SS[which(is.na(base$acceso_SS))]=0.7238 # 1 NAs
base$centros_medicos[which(is.na(base$centros_medicos))]=4 # 6 NAs
base$densidad2020[which(is.na(base$densidad2020))]=312.34
base$gini[which(is.na(base$gini))]=0.3915
```

```{r}
base$region<-as.factor(base$region)
base2<-base%>% 
  dplyr::select(-cve_ent,-mpio,-X,-entidad)
set.seed(123)
modelo_lm<-lm(tasa_covid ~ .,data=base2)
jtools::summ(modelo_lm) 
```

### Modelo de regresión global (no espacial)

#### División de datos

```{r split}
set.seed(123123)
split=caTools::sample.split(base2$tasa_covid,SplitRatio=0.67)
train=subset(base2,split==TRUE) 
test=subset(base2,split==FALSE)
rm(split)
```

#### `Random Forest`

```{r}
random_forest<-randomForest(tasa_covid ~ .,data=train,importance=TRUE,proximity=TRUE)
print(random_forest) 
```

#### `Root Mean Square Error (RMSE)`

```{r}
rf_prediction_test_data<-predict(random_forest,test)
(rf_rmse<-Metrics::rmse(rf_prediction_test_data,test$tasa_covid))
```

### Modelos de regresión GWR

```{r message=FALSE, warning=FALSE, include=FALSE}
mx_mpios_map<-readOGR(dsn='/Users/kizarihdz/Documents/8/Bloques/Planeación estratégica basada en analítica prescriptiva/datos_act3/mx_geo_data.shp')
```

```{r include=FALSE}
mx_mpios_map<-mx_mpios_map[,-4] ### drop repeated IDUNICO
mx_mpios_map$poblacion<-as.numeric(mx_mpios_map$poblacion) 
mx_mpios_map$covid_2021<-as.numeric(mx_mpios_map$covid_2021) 
mx_mpios_map$tasa_covid<-as.numeric(mx_mpios_map$tasa_covid)
```

```{r include=FALSE}
mx_mpios_map$hospitales<-as.numeric(mx_mpios_map$hospitales) 
mx_mpios_map$region<-as.factor(mx_mpios_map$region)
```


```{r include=FALSE}
mx_mpios_map$pobreza[which(is.na(mx_mpios_map$pobreza))]=0.6195 # 1 NAs
mx_mpios_map$acceso_ss[which(is.na(mx_mpios_map$acceso_ss))]=0.7238 # 1 NAs
mx_mpios_map$hospitales[which(is.na(mx_mpios_map$hospitales))]=4 # 6 NAs
mx_mpios_map$densidad_2[which(is.na(mx_mpios_map$densidad_2))]=312.34
```

#### Auto Regresión Espacial

```{r}
swm_queen<-poly2nb(mx_mpios_map,queen=TRUE)
```

```{r}
rswm_queen<-nb2listw(swm_queen,style="W",zero.policy=TRUE)
```

```{r}
spatial_autoregressive<-lagsarlm(tasa_covid ~ .-CVE_ENT-IDUNICO-municipio-CODELAG-region-grado_rs-entidad,data=mx_mpios_map,listw=rswm_queen,Durbin=FALSE) 
summary(spatial_autoregressive)
```

##### `Root Mean Square Error (RMSE)`

```{r message=FALSE, warning=FALSE}
y_pred<-predict(spatial_autoregressive)
(sar_rmse<-Metrics::rmse(y_pred,mx_mpios_map$tasa_covid))
```

#### Modelo 2

```{r message=FALSE, warning=FALSE}
bw1<-bw.gwr(tasa_covid ~ hospitales+poblacion+densidad_2+rezago_soc+inclusion_,approach="AIC",adaptive=TRUE,data=mx_mpios_map)
```

```{r message=FALSE, warning=FALSE}
m.gwr<-gwr.basic(tasa_covid ~ hospitales+poblacion+densidad_2+rezago_soc+inclusion_,adaptive=TRUE,data=mx_mpios_map,bw=bw1) 
m.gwr
```

```{r}
gwr_sf=st_as_sf(m.gwr$SDF)
```

```{r}
gwr_sf$y_predicted<-exp(gwr_sf$yhat)
```

### Selección de modelo de regresión

Evaluando el RMSE del modelo `Random Forest` y del modelo Espacial Autoregresivo, se determina que el mejor modelo es **Random Forest**.

```{r}
cat("RMSE del modelo Espacial Autoregresivo: ",sar_rmse,"  RMSE del modelo Random Forest:",rf_rmse)
```


<hr>

## Hallazgos

## {.tabset}

### Difrencias entre las regresiones espaciales

**¿Cuáles son las diferencias entre la estimación de modelo de regresión global y la estimación de modelo de regresión local GWR?**

* **Variabilidad**: En un modelo espacial global se usa el mismo modelo con los mismos coeficientes para cada unidad espacial individual (sean estas manzanas, municipios etc.). En un modelo espacial local los coeficientes cambian según cada unidad espacial. Esto permite que el modelo detecte patrones y cambios locales y que los valores atípicos tengan un menor efecto en los modelos.
* **Adaptación según cercanía**: En el modelo espacial local se usan pesas geográficas con el fin de darle importancia a unidades espaciales cercanas a la que se está analizando, y menos peso a las que están más lejos. Un modelo global no toma esto en cuenta.

**¿Cómo saber cuál modelo usar?**

Es mejor usar la regresión local cuando se teoriza que la relación entre las variables cambia en diferentes regiones y existen patrones no lineales. Es importante tomar en cuenta que un modelo de regresión local es más complejo y entre más unidades espaciales más tiempo y capacidad tomará.

### Hallazgos del análisis

**¿Cuáles son los principales factores socioeconómicos que propician un incremento/disminución de los casos confrmados de Covid-19?**

Los hallazgos muestran que ciertos factores socioeconómicos tienen una correlación significativa con la incidencia de Covid-19, como la densidad poblacional, la cantidad de centros médicos, la inclusión financiera, entre otros. En particular, se encontró que la densidad poblacional y el turismo son factores que propician un aumento en la propagación del virus. Además, la inclusión financiera se correlacionó con una disminución en la propagación de Covid-19.

**¿Hay factores en municipios cercanos que propicien un incremento/disminución de los casos confrmados de Covid-19 en un municipio en particular?**

En cuanto a la relación entre municipios cercanos, se encontró autocorrelación positiva en la conectividad del norte de México, lo que puede indicar patrones similares en la planificación de infraestructura que afectan la movilidad, acceso a servicios y desarrollo económico en áreas cercanas.

**¿Cuáles son los principales factores socioeconómicos que caracterizan los clústers de casos confirmados de Covid-19?**

Los principales factores socioeconómicos que caracterizan los clústers de casos confirmados de Covid-19 son la densidad poblacional, la cantidad de centros médicos y las variables socioeconómicas relevantes de cada entidad.

**¿Qué tipo de factores socioeconómicos regionales pudieran contribuir al crecimiento y/o expansión de organizaciones relacionadas con la prestación de servicios de salud (por ejemplo, hospitales y/o centros privados de atención para la salud)?**

En el análisis se encontró que ciertas variables socioeconómicas como la densidad poblacional, la cantidad de centros médicos, la inclusión financiera y la ubicación geográfica se correlacionaron significativamente con la propagación del COVID-19. La densidad poblacional y las variables socioeconómicas también pueden contribuir al crecimiento y expansión de organizaciones relacionadas con la prestación de servicios de salud. Por lo tanto, se recomienda que las organizaciones consideren estos factores al planificar la expansión y establecimiento de servicios de salud en diferentes regiones.

### Hallazgos del modelo

* Se realizó un modelo de regresión lineal, utilizando todas las variables independientes a excepción de `cve_Ent`, `municipio` y `entidad`. El resultado demostró que `regionOtro` y `regionSur` no son relevantes para explicar el comportamiento de la variable dependiente. 
* Dentro de esta regresión las variables que más peso tienen son `gini`, `inclusion_fin`, `poblacion` y `pobreza`.
* Evaluando el RMSE del modelo `Random Forest` y el modelo Espacial Autoregresivo, se puede visualizar que el mejor modelo es `Random Forest`. La diferencia es de 3.46, lo que indica que es posible que con más variables el otro modelo puede llegar a ser el indicado.
* Analizando el efecto del modelo GWR y las variables independientes en la región centro se observan diferencias al resto del país.

En la región centro se puede evidenciar que al igual que la mayoría del país, los valores rondan entre 0 y 5.

```{r message=FALSE, warning=FALSE}
qtm(gwr_sf,fill="densidad_2_TV")
```

En la región centro se puede evidenciar que al igual que la mayoría del país, los valores rondan entre -2 y 2.

```{r message=FALSE, warning=FALSE}
qtm(gwr_sf,fill="poblacion_TV")
```

En la región centro se puede evidenciar que al igual que la mayoría del país, los valores rondan entre 0 y 5.

```{r message=FALSE, warning=FALSE}
qtm(gwr_sf,fill="inclusion__TV")
```

En la región centro, el rezago social afecta entre -10 y -8. Es la variable con más rango.

```{r message=FALSE, warning=FALSE}
qtm(gwr_sf,fill="rezago_soc_TV")
```

En la región centro se puede evidenciar que al igual que la mayoría del país, los valores rondan entre 0 y 5.

```{r message=FALSE, warning=FALSE}
qtm(gwr_sf,fill="hospitales_TV")
```

<hr>

## Sugerencias

Para concluir, algunas sugerencias son:

* **Establecer clínicas y centros de salud en áreas con baja densidad poblacional**: Dado que la densidad poblacional se correlaciona positivamente con la propagación del COVID-19, es recomendable que las organizaciones de servicios de salud consideren expandirse en áreas con baja densidad poblacional para evitar la concentración de personas en un solo lugar. Al hacerlo, se puede mejorar el acceso a la atención médica para las personas que viven en áreas remotas y disminuir la propagación del virus.
* **Desarrollar programas de inclusión financiera**: Según el análisis, la inclusión financiera se correlaciona con una disminución en la propagación del COVID-19. Por lo tanto, las organizaciones de servicios de salud podrían desarrollar programas para mejorar la inclusión financiera de las personas, como ofrecer planes de pago a plazos y descuentos en los servicios médicos para aquellos que enfrentan dificultades financieras. Al hacerlo, se puede mejorar el acceso a la atención médica y reducir la propagación del virus al garantizar que todas las personas tengan acceso a los servicios de salud necesarios.

Además, considerando la autocorrelación positiva encontrada en la conectividad del norte de México, se podría explorar la expansión en áreas cercanas y con patrones similares de planificación de infraestructura para mejorar la movilidad y el acceso a servicios de salud en esas áreas.

En resumen, al considerar estos factores socioeconómicos y geográficos, las organizaciones de servicios de salud pueden desarrollar estrategias de expansión efectivas y sostenibles para mejorar el acceso a la atención médica y reducir la propagación del Covid-19.

<hr>

## Bibliografía

Los datos se obtivieron del Instituto Nacional de Estadística y Geografía (INEGI) y el Directorio Estadístico Nacional de Unidades Económicas (DENUE).

Arceo-Gómez, E., Campos-Vazquez, R., Esquivel, G., Alcaraz, E., Martinez, L., & Lopez, N. (2022). *The Income Gradient in COVID-19 Mortality and Hospitalisation: An Observational Study with Social Security Administrative Records in Mexico*. The Lancet Regional Health – Americas, 6. https://www.sciencedirect.com/science/article/pii/S2667193X21001113?via%3Dihub

Cámara Nacional de la Industria Farmacéutica (CANIFARMA). https://codigof.mx/en-mexico-las-personas-pobres-tienen-5-veces-mas-probabilidades-de-fallecer-por-covid-19-que-las-de-mayores-ingresos/

Columbia University. (2023). *Geographically Weighted Regression*. Columbia University. https://www.publichealth.columbia.edu/research/population-health-methods/geographically-weighted-regression

OpenAI. (2023). ChatGPT. Comunicación personal.

